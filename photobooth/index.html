<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Vizrize Photobooth Receipt</title>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background-color: #f7f5f2;
    font-family: "Poppins", sans-serif;
    color: #3a2e2a;
    overflow: hidden;
  }

  video, #photo-preview {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    object-fit: cover;
  }

  video { transform: scaleX(-1); } /* Mirror untuk preview */
  video.normal { filter: none; }
  video.bw { filter: grayscale(100%) brightness(1.1) contrast(1.05); }

  #photo-preview {
    display: none;
    z-index: 5;
    background-color: #fff;
  }

  .overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    pointer-events: none;
    z-index: 10;
  }

  .top-bar { margin-top: 15px; text-align: center; }
  .logo { font-weight: 600; font-size: 1.3em; color: #a58b6f; }
  .subtitle { font-size: 0.85em; color: #b6a089; letter-spacing: 2px; }

  .controls, #preview-controls {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 12px;
    pointer-events: auto;
    z-index: 15;
  }

  #preview-controls { display: none; }

  button {
    background-color: rgba(255, 255, 255, 0.75);
    border: none;
    border-radius: 20px;
    padding: 10px 25px;
    font-size: 0.95em;
    color: #5a4a3d;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    cursor: pointer;
  }

  #countdown {
    position: absolute;
    font-size: 6em;
    color: white;
    text-shadow: 0 0 20px rgba(0,0,0,0.5);
    display: none;
    z-index: 12;
  }

  #print-anim, #qr-section {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background-color: rgba(255,255,255,0.96);
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 20;
  }

  .countdown-text {
    font-size: 1.2em;
    margin-top: 10px;
    color: #6b5c4b;
  }
</style>
</head>

<body>
<video id="camera" autoplay playsinline class="normal"></video>
<canvas id="canvas" style="display:none;"></canvas>
<img id="photo-preview" alt="preview" />

<div class="overlay">
  <div class="top-bar">
    <div class="logo">VIZRIZE</div>
    <div class="subtitle">PHOTOBOOTH RECEIPT</div>
  </div>
  <div id="countdown"></div>
</div>

<div class="controls" id="main-controls">
  <button id="startBtn" disabled>üì∏ Mulai</button>
  <button id="filterBtn">Filter: Normal</button>
</div>

<div id="preview-controls">
  <button id="printBtn">Cetak üñ®Ô∏è</button>
  <button id="retryBtn">Ulangi üîÅ</button>
</div>

<div id="print-anim">
  <h2>‚ú® Sedang mencetak fotomu ‚ú®</h2>
  <div style="font-size:4em;">üñ®Ô∏èüìÑ</div>
</div>

<div id="qr-section">
  <h2>Scan QR untuk mengunduh üí´</h2>
  <div id="qrcode"></div>
  <div class="countdown-text" id="qrCountdown"></div>
</div>

<script>
  const API_KEY = "1d1aa4b919d175436c480b9509c088e7";

  const video = document.getElementById("camera");
  const canvas = document.getElementById("canvas");
  const photoPreview = document.getElementById("photo-preview");
  const countdownEl = document.getElementById("countdown");
  const mainControls = document.getElementById("main-controls");
  const previewControls = document.getElementById("preview-controls");
  const printAnim = document.getElementById("print-anim");
  const qrSection = document.getElementById("qr-section");
  const qrcodeDiv = document.getElementById("qrcode");
  const qrCountdown = document.getElementById("qrCountdown");
  const startBtn = document.getElementById("startBtn");
  const filterBtn = document.getElementById("filterBtn");
  const printBtn = document.getElementById("printBtn");
  const retryBtn = document.getElementById("retryBtn");

  let currentFilter = "normal";

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
      video.srcObject = stream;
      video.onloadedmetadata = () => { startBtn.disabled = false; };
    } catch (e) {
      alert("Kamera gagal diakses üò¢");
    }
  }
  startCamera();

  filterBtn.onclick = () => {
    if (currentFilter === "normal") {
      currentFilter = "bw";
      video.className = "bw";
      filterBtn.textContent = "Filter: B&W";
    } else {
      currentFilter = "normal";
      video.className = "normal";
      filterBtn.textContent = "Filter: Normal";
    }
  };

  startBtn.onclick = async () => {
    mainControls.style.display = "none";
    countdownEl.style.display = "block";
    for (let i = 3; i > 0; i--) {
      countdownEl.textContent = i;
      await new Promise(r => setTimeout(r, 1000));
    }
    countdownEl.style.display = "none";
    takePhoto();
  };

  function takePhoto() {
    const ctx = canvas.getContext("2d");
    canvas.width = video.videoWidth || 1280;
    canvas.height = video.videoHeight || 720;

    // draw tanpa mirror
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    if (currentFilter === "bw") {
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      for (let i = 0; i < imgData.data.length; i += 4) {
        const avg = (imgData.data[i] + imgData.data[i + 1] + imgData.data[i + 2]) / 3;
        imgData.data[i] = imgData.data[i + 1] = imgData.data[i + 2] = avg;
      }
      ctx.putImageData(imgData, 0, 0);
    }

    // Tambahkan frame putih
    const frameHeight = canvas.height * 1.15;
    const frameCanvas = document.createElement("canvas");
    const fctx = frameCanvas.getContext("2d");
    frameCanvas.width = canvas.width;
    frameCanvas.height = frameHeight;

    fctx.fillStyle = "#fff";
    fctx.fillRect(0, 0, frameCanvas.width, frameCanvas.height);
    fctx.drawImage(canvas, 0, 0, frameCanvas.width, canvas.height);

    // Tambahkan teks info bawah
    const date = new Date().toLocaleDateString("id-ID", { day: '2-digit', month: 'long', year: 'numeric' });
    fctx.font = `${canvas.width * 0.03}px Poppins`;
    fctx.fillStyle = "#3a2e2a";
    fctx.textAlign = "center";
    fctx.fillText(`VIZRIZE Photobooth ‚Ä¢ Jakarta, Indonesia`, frameCanvas.width / 2, frameCanvas.height - 45);
    fctx.font = `${canvas.width * 0.025}px Poppins`;
    fctx.fillText(date, frameCanvas.width / 2, frameCanvas.height - 15);

    const dataUrl = frameCanvas.toDataURL("image/jpeg");
    photoPreview.src = dataUrl;
    photoPreview.style.display = "block";
    video.style.display = "none";
    previewControls.style.display = "flex";
  }

  retryBtn.onclick = () => {
    video.style.display = "block";
    photoPreview.style.display = "none";
    previewControls.style.display = "none";
    mainControls.style.display = "flex";
  };

  printBtn.onclick = async () => {
    previewControls.style.display = "none";
    photoPreview.style.display = "none";
    printAnim.style.display = "flex";
    await new Promise(r => setTimeout(r, 2000));
    printAnim.style.display = "none";
    uploadPhoto();
  };

  async function uploadPhoto() {
    const base64 = photoPreview.src.split(",")[1];
    const formData = new FormData();
    formData.append("image", base64);

    const response = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, {
      method: "POST",
      body: formData
    });

    const result = await response.json();
    if (result.data && result.data.url) {
      showQRCode(result.data.url);
    } else {
      alert("Upload gagal üò¢");
      video.style.display = "block";
      mainControls.style.display = "flex";
    }
  }

  async function showQRCode(url) {
    qrSection.style.display = "flex";
    qrcodeDiv.innerHTML = "";
    new QRCode(qrcodeDiv, { text: url, width: 200, height: 200 });

    for (let i = 10; i > 0; i--) {
      qrCountdown.textContent = `Kembali ke kamera dalam ${i} detik...`;
      await new Promise(r => setTimeout(r, 1000));
    }
    qrSection.style.display = "none";
    video.style.display = "block";
    mainControls.style.display = "flex";
  }
</script>
</body>
</html>
