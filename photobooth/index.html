<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vizrize Photobooth</title>
<style>
/* Global */
body, html {margin:0; padding:0; height:100%; font-family:'Roboto Mono',monospace; background:#f5f0e6;}
/* Kamera */
#cameraWrap {position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#f5f0e6;}
video#camera {width:100%; height:100%; object-fit:cover; transform:scaleX(-1);}
/* Tombol mulai */
#startBtnCenter {position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); padding:14px 22px; font-size:20px; cursor:pointer; z-index:40; background:#fff; border-radius:999px; box-shadow:0 8px 24px rgba(0,0,0,0.06);}
/* Countdown 3 detik */
#countdown {position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-size:72px; font-weight:bold; color:#222; display:none; z-index:50;}
/* Preview receipt */
#receiptCard {display:none; width:90%; max-width:400px; margin:18px auto; background:#fff; border-radius:6px; box-shadow:0 12px 36px rgba(0,0,0,0.08); overflow:hidden; position:relative; text-align:center;}
.photoImg { width:100%; height:auto; border:6px solid #fff; }
#footerText { padding:8px; font-size:14px; color:#333; }
#previewControls { display:none; justify-content:center; gap:12px; padding:10px; }
button { padding:10px 16px; border-radius:999px; border:1px solid rgba(0,0,0,0.1); cursor:pointer; background:#fff; font-weight:700; }
button.primary { background:#faf8f6; }
.bw { filter:grayscale(100%) contrast(1.1); }
/* Overlay upload */
#processingOverlay { position:fixed; inset:0; background:rgba(0,0,0,0.36); display:none; align-items:center; justify-content:center; color:#fff; font-size:24px; z-index:60; }
</style>
</head>
<body>

<div id="cameraWrap">
  <video id="camera" autoplay muted playsinline></video>
  <div id="startBtnCenter">MULAI</div>
</div>

<div id="countdown"></div>

<div id="receiptCard">
  <canvas id="receiptCanvas" style="width:100%;"></canvas>
  <img id="photoPreview" class="photoImg"/>
  <div id="footerText"></div>
  <div id="previewControls">
    <button id="filterBtn">Filter: Normal</button>
    <button id="retryBtn">Ulangi</button>
    <button id="printUploadBtn" class="primary">Upload & QR</button>
  </div>
</div>

<div id="processingOverlay">Uploading...</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
const IMGBB_API_KEY="1d1aa4b919d175436c480b9509c088e7";
const LOCATION_LABEL="Jakarta";
const RECEIPT_WIDTH=576;

const video=document.getElementById('camera');
const startBtnCenter=document.getElementById('startBtnCenter');
const receiptCard=document.getElementById('receiptCard');
const photoPreview=document.getElementById('photoPreview');
const footerText=document.getElementById('footerText');
const previewControls=document.getElementById('previewControls');
const retryBtn=document.getElementById('retryBtn');
const printUploadBtn=document.getElementById('printUploadBtn');
const processingOverlay=document.getElementById('processingOverlay');
const filterBtn=document.getElementById('filterBtn');
const receiptCanvas=document.getElementById('receiptCanvas');
const rcCtx=receiptCanvas.getContext('2d');
const countdownEl=document.getElementById('countdown');
let lastReceiptDataUrl=null;
let filterMode='normal';

// buka kamera
async function openCamera(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:{ideal:1280},height:{ideal:1920}},audio:false});
    video.srcObject=stream;
  }catch(e){alert('Tidak bisa mengakses kamera: '+(e.message||e));}
}
openCamera();

// tombol mulai
startBtnCenter.addEventListener('click',async()=>{
  startBtnCenter.style.display='none';
  await countdown(3);
  captureReceiptFrame();
});

// tombol ulangi
retryBtn.addEventListener('click',()=>{
  previewControls.style.display='none';
  receiptCard.style.display='none';
  startBtnCenter.style.display='block';
  document.getElementById('cameraWrap').style.display='flex';
});

// filter
filterBtn.addEventListener('click',()=>{
  if(filterMode==='normal'){filterMode='bw';filterBtn.textContent='Filter: B&W';photoPreview.classList.add('bw');}
  else{filterMode='normal';filterBtn.textContent='Filter: Normal';photoPreview.classList.remove('bw');}
});

// cetak/upload
printUploadBtn.addEventListener('click',async()=>{
  try{
    processingOverlay.style.display='flex';
    const url=await uploadReceiptImage(lastReceiptDataUrl);
    processingOverlay.style.display='none';
    const encodedUrl = encodeURIComponent(url);
    window.location.href = `preview.html?img=${encodedUrl}`;
  }catch(err){
    processingOverlay.style.display='none';
    alert('Upload gagal: '+(err.message||err));
    retryBtn.click();
  }
});

// countdown sebelum capture
async function countdown(sec){
  countdownEl.style.display='block';
  for(let i=sec;i>0;i--){
    countdownEl.textContent = i;
    await new Promise(r => setTimeout(r,1000));
  }
  countdownEl.style.display='none';
}

// capture foto + buat receipt
function captureReceiptFrame(){
  const vw=video.videoWidth||1280;
  const vh=video.videoHeight||720;
  const sideMargin=Math.round(RECEIPT_WIDTH*0.06);
  const photoW=RECEIPT_WIDTH-sideMargin*2;
  const scale=photoW/vw;
  const photoH=Math.round(vh*scale);
  const headerH=Math.round(RECEIPT_WIDTH*0.12);
  const footerH=Math.round(RECEIPT_WIDTH*0.2);
  const canvasW=RECEIPT_WIDTH;
  const canvasH=headerH+photoH+footerH;
  receiptCanvas.width=canvasW;
  receiptCanvas.height=canvasH;

  rcCtx.fillStyle='#fff'; rcCtx.fillRect(0,0,canvasW,canvasH);

  rcCtx.fillStyle='#000'; rcCtx.textAlign='center';
  rcCtx.font=`${Math.round(canvasW*0.06)}px monospace`; rcCtx.fillText('VIZRIZE PHOTOBOOTH RECEIPT',canvasW/2,Math.round(headerH*0.55));
  rcCtx.font=`${Math.round(canvasW*0.035)}px monospace`; rcCtx.fillText('Jakarta • Photobooth',canvasW/2,Math.round(headerH*0.88));

  const photoX=sideMargin; const photoY=headerH; const innerBorder=Math.max(6,Math.round(photoW*0.03));
  rcCtx.fillStyle='#fff'; rcCtx.fillRect(photoX,photoY,photoW,photoH);
  const tmp=document.createElement('canvas'); tmp.width=vw; tmp.height=vh; const tctx=tmp.getContext('2d');
  tctx.save(); tctx.scale(-1,1); tctx.drawImage(video,-vw,0,vw,vh); tctx.restore();
  rcCtx.drawImage(tmp,0,0,vw,vh,photoX+innerBorder,photoY+innerBorder,photoW-innerBorder*2,photoH-innerBorder*2);

  if(filterMode==='bw'){
    const imgData=rcCtx.getImageData(photoX+innerBorder,photoY+innerBorder,photoW-innerBorder*2,photoH-innerBorder*2);
    for(let i=0;i<imgData.data.length;i+=4){
      const avg=(imgData.data[i]+imgData.data[i+1]+imgData.data[i+2])/3;
      imgData.data[i]=imgData.data[i+1]=imgData.data[i+2]=avg;
    }
    rcCtx.putImageData(imgData,photoX+innerBorder,photoY+innerBorder);
  }

  const dateStr=new Date().toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'});
  rcCtx.fillStyle='#000'; rcCtx.font=`${Math.round(canvasW*0.04)}px monospace`; rcCtx.fillText(`${LOCATION_LABEL} • ${dateStr}`,canvasW/2,photoY+photoH+Math.round(footerH*0.45));
  rcCtx.font=`${Math.round(canvasW*0.03)}px monospace`; rcCtx.fillText('Scan QR untuk mengunduh foto',canvasW/2,photoY+photoH+Math.round(footerH*0.78));

  lastReceiptDataUrl=receiptCanvas.toDataURL('image/jpeg',0.92);
  photoPreview.src=lastReceiptDataUrl;
  footerText.textContent=`${LOCATION_LABEL} • ${dateStr}`;
  receiptCard.style.display='block';
  previewControls.style.display='flex';
  document.getElementById('cameraWrap').style.display='none';

  setTimeout(()=>{
    previewControls.style.display='none';
    receiptCard.style.display='none';
    startBtnCenter.style.display='block';
    document.getElementById('cameraWrap').style.display='flex';
  },10000);
}

// upload ke ImgBB
async function uploadReceiptImage(dataUrl){
  if(!dataUrl) throw new Error('Tidak ada gambar');
  const base64=dataUrl.split(',')[1]; const form=new FormData();
  form.append('image',base64); form.append('name',`vizrize_${Date.now()}`);
  const resp=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:'POST',body:form});
  if(!resp.ok) throw new Error('ImgBB upload gagal (network)');
  const json=await resp.json();
  if(!json||!json.data||!json.data.url) throw new Error('ImgBB tidak mengembalikan URL');
  return json.data.url;
}
</script>
</body>
</html>
