<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vizrize Photobooth â€” Receipt (Cloudinary)</title>
<!-- QR lib -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<style>
  :root{
    --bg:#f5f0e6;--muted:#333;--accent:#111;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Roboto,Arial;background:var(--bg);color:var(--muted);overflow:hidden}
  /* Camera area */
  #cameraWrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:1}
  video#camera{width:100vw;height:100vh;object-fit:cover;transform:scaleX(-1)}
  /* UI */
  .panel{position:relative;z-index:30;width:min(820px,94vw);margin:18px auto;display:flex;flex-direction:column;align-items:center;gap:12px}
  .brand{font-weight:800;color:var(--accent);letter-spacing:1px;font-size:18px}
  .subtitle{font-size:13px;color:#6e6156;margin-top:2px}
  .frameWrap{width:clamp(300px,72vw,720px);display:flex;align-items:center;justify-content:center;padding:6px}
  .receiptCard{width:100%;max-width:640px;background:#fff;border-radius:6px;box-shadow:0 12px 36px rgba(0,0,0,0.08);overflow:hidden;display:flex;flex-direction:column}
  .receiptHeader{padding:12px;border-bottom:1px dashed #ded6c8;text-align:center;font-family:monospace}
  .headerTitle{font-weight:800;color:#111;font-size:15px}
  .photoHolder{display:flex;align-items:center;justify-content:center;padding:10px;background:transparent;position:relative}
  .photoImg{display:block;max-width:100%;height:auto;border:10px solid #fff;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
  .receiptBody{padding:8px 18px 14px;font-family:monospace}
  .receiptFooter{padding:8px 18px;border-top:1px dashed #eee;text-align:center;font-size:12px;color:#333;background:transparent}
  .controlsRow{display:flex;gap:10px;justify-content:center;margin-top:6px}
  button{background:#fff;border:1px solid rgba(0,0,0,0.06);padding:10px 14px;border-radius:999px;font-weight:700;color:var(--muted);cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,0.06)}
  button.primary{background:linear-gradient(90deg,#fff,#faf8f6);color:var(--accent)}
  #qrOverlay,#processingOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.36);z-index:60}
  .modalBox{background:#fff;padding:12px;border-radius:10px;text-align:center;max-width:92vw}
  #qrcode{margin:6px auto}
  #countdown{position:fixed;top:18px;left:50%;transform:translateX(-50%);font-size:48px;color:#fff;text-shadow:0 8px 18px rgba(0,0,0,0.45);display:none;z-index:70}
  #flash{position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:80;transition:opacity 220ms ease-out}
  #modeSelector{display:flex;gap:12px;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:50}
  .small{font-size:13px}
  @media (max-width:560px){.photoHolder{padding:8px}.receiptHeader{padding:8px}.receiptFooter{padding:8px}}
</style>
</head>
<body>

<div id="cameraWrap"><video id="camera" autoplay playsinline></video></div>
<div id="flash" aria-hidden="true"></div>

<!-- Mode selector (1x or 3x strip) -->
<div id="modeSelector">
  <button id="singleBtn" class="primary">ðŸ“¸ 1x Foto</button>
  <button id="tripleBtn" class="primary">ðŸ“¸ 3x Foto (Strip)</button>
</div>

<div class="panel" aria-live="polite">
  <div class="brand">VIZRIZE</div>
  <div class="subtitle">PHOTOBOOTH RECEIPT</div>

  <div class="frameWrap">
    <div class="receiptCard" id="receiptCard" style="display:none" aria-hidden="true">
      <div class="receiptHeader">
        <div class="headerTitle">VIZRIZE PHOTOBOOTH</div>
        <div class="small">Jakarta Â· Photobooth</div>
      </div>
      <div class="photoHolder">
        <img id="photoPreview" class="photoImg" alt="Hasil foto">
      </div>
      <div class="receiptBody" id="receiptBody"></div>
      <div class="receiptFooter" id="footerText">Jakarta â€¢ --</div>
    </div>
  </div>

  <div class="controlsRow" id="previewControls" style="display:none">
    <button id="retryBtn">Ulangi</button>
    <button id="printUploadBtn" class="primary">Cetak / Upload</button>
    <button id="btPrintBtn">Print Bluetooth</button>
  </div>
</div>

<!-- Overlays -->
<div id="processingOverlay"><div class="modalBox"><strong>Memproses & Mengupload...</strong><div style="margin-top:8px;color:#6b5c4b;font-size:13px">Jangan tutup browser</div></div></div>
<div id="qrOverlay"><div class="modalBox"><div style="font-weight:700;margin-bottom:8px">Scan QR untuk unduh</div><div id="qrcode"></div><div id="qrUrl" style="margin-top:8px;font-size:12px;color:#6b5c4b;word-break:break-all;max-width:260px"></div><div id="qrCountdown" style="margin-top:8px;color:#6b5c4b"></div></div></div>

<div id="countdown" aria-hidden="true"></div>
<audio id="snapSound" preload="auto"></audio>
<canvas id="receiptCanvas" style="display:none"></canvas>

<script>
/* ============================
   CONFIG - sesuaikan di sini
   ============================ */
const CLOUD_NAME = "dcqqaebln";              // <-- cloud name kamu (sudah diisi)
const UPLOAD_PRESET = "vizrize_unsigned";    // <-- ganti sesuai preset di Cloudinary
const LOCATION_LABEL = "Jakarta";
const RETURN_SECONDS = 8;
const RECEIPT_WIDTH = 384; // pixel, cocok untuk 58mm thermal (~203 dpi)

/* ============================
   DOM references
   ============================ */
const video = document.getElementById('camera');
const flashEl = document.getElementById('flash');
const countdownEl = document.getElementById('countdown');
const receiptCanvas = document.getElementById('receiptCanvas');
const rcCtx = receiptCanvas.getContext('2d');
const photoPreview = document.getElementById('photoPreview');
const receiptCard = document.getElementById('receiptCard');
const previewControls = document.getElementById('previewControls');
const retryBtn = document.getElementById('retryBtn');
const printUploadBtn = document.getElementById('printUploadBtn');
const btPrintBtn = document.getElementById('btPrintBtn');
const processingOverlay = document.getElementById('processingOverlay');
const qrOverlay = document.getElementById('qrOverlay');
const qrcodeDiv = document.getElementById('qrcode');
const qrUrlEl = document.getElementById('qrUrl');
const qrCountdownEl = document.getElementById('qrCountdown');
const modeSelector = document.getElementById('modeSelector');
const singleBtn = document.getElementById('singleBtn');
const tripleBtn = document.getElementById('tripleBtn');
const snapSoundEl = document.getElementById('snapSound');

let captureMode = 'single';
let lastReceiptDataUrl = null;

/* ============================
   Audio (Web Audio API) - no external files needed
   ============================ */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playBeep(freq=1000, duration=0.06, type='sine', gain=0.07){
  try{
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
    g.gain.setValueAtTime(gain, audioCtx.currentTime);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + duration);
  }catch(e){}
}
function playTick(){ playBeep(1200,0.06,'sine',0.06); }
function playShutter(){ playBeep(700,0.03,'triangle',0.09); setTimeout(()=>playBeep(1200,0.035,'square',0.06),70); }

/* ============================
   Camera open
   ============================ */
async function openCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:'user', width:{ideal:1280}, height:{ideal:1920} }, audio:false
    });
    video.srcObject = stream;
  }catch(e){
    alert('Tidak bisa mengakses kamera: ' + (e.message||e));
  }
}
openCamera();

/* ============================
   Mode handlers
   ============================ */
singleBtn.addEventListener('click', ()=>{ captureMode='single'; modeSelector.style.display='none'; startCaptureSequence(); });
tripleBtn.addEventListener('click', ()=>{ captureMode='triple'; modeSelector.style.display='none'; startCaptureSequence(); });

retryBtn.addEventListener('click', ()=>{
  previewControls.style.display='none';
  receiptCard.style.display='none';
  qrOverlay.style.display='none';
  document.getElementById('cameraWrap').style.display='flex';
  modeSelector.style.display='flex';
});

/* ============================
   Countdown (with ticks)
   ============================ */
async function countdown(sec){
  // resume audio context on user gesture
  if(audioCtx.state === 'suspended') await audioCtx.resume();
  countdownEl.style.display='block';
  for(let i=sec;i>0;i--){
    countdownEl.textContent = i;
    playTick();
    await new Promise(r=>setTimeout(r,1000));
  }
  countdownEl.style.display='none';
}

/* ============================
   Capture single frame (base64)
   ============================ */
function captureFrameOnly(){
  const vw = video.videoWidth || 1280;
  const vh = video.videoHeight || 720;
  const tmp = document.createElement('canvas');
  tmp.width = vw; tmp.height = vh;
  const tctx = tmp.getContext('2d');
  tctx.save(); tctx.scale(-1,1); // mirror selfie
  tctx.drawImage(video, -vw, 0, vw, vh);
  tctx.restore();
  return tmp.toDataURL('image/jpeg', 0.9);
}

/* ============================
   Draw receipt (1x)
   ============================ */
function drawReceiptSingle(photoDataUrl){
  // layout
  const canvasW = RECEIPT_WIDTH;
  const sidePad = Math.round(canvasW*0.06);
  const photoW = canvasW - sidePad*2;
  const scaleH = 1.35;
  const photoH = Math.round(photoW * (4/3)); // keep portrait-ish
  const headerH = Math.round(canvasW*0.12);
  const footerH = Math.round(canvasW*0.22);
  const canvasH = headerH + photoH + footerH;

  receiptCanvas.width = canvasW;
  receiptCanvas.height = canvasH;

  // background
  rcCtx.fillStyle = '#fffdf7';
  rcCtx.fillRect(0,0,canvasW,canvasH);

  // header
  rcCtx.fillStyle = '#111';
  rcCtx.textAlign = 'center';
  rcCtx.font = `${Math.round(canvasW*0.06)}px monospace`;
  rcCtx.fillText('VIZRIZE PHOTOBOOTH', canvasW/2, Math.round(headerH*0.45));
  rcCtx.font = `${Math.round(canvasW*0.028)}px monospace`;
  rcCtx.fillText(`${LOCATION_LABEL} â€¢ Photobooth`, canvasW/2, Math.round(headerH*0.82));

  // photo area
  const img = new Image();
  img.src = photoDataUrl;
  img.onload = ()=>{
    // photo white border
    const photoX = sidePad;
    const photoY = headerH + 8;
    rcCtx.fillStyle = '#ffffff';
    rcCtx.fillRect(photoX, photoY, photoW, photoH);

    rcCtx.drawImage(img, photoX + 8, photoY + 8, photoW - 16, photoH - 16);

    // details
    const dateStr = new Date().toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'});
    rcCtx.fillStyle = '#111';
    rcCtx.font = `${Math.round(canvasW*0.034)}px monospace`;
    rcCtx.textAlign = 'center';
    rcCtx.fillText(`${LOCATION_LABEL} â€¢ ${dateStr}`, canvasW/2, photoY + photoH + Math.round(footerH*0.45));

    rcCtx.font = `${Math.round(canvasW*0.028)}px monospace`;
    rcCtx.fillText('Scan QR untuk mengunduh foto', canvasW/2, photoY + photoH + Math.round(footerH*0.78));

    // small barcode-like pattern
    const bY = photoY + photoH + Math.round(footerH*0.85);
    rcCtx.fillStyle = '#111';
    for(let i=0;i<canvasW-2*sidePad;i+=6){
      const h = (i%30===0) ? 18 : Math.round(6 + Math.random()*12);
      rcCtx.fillRect(sidePad + i, bY - h, 3, h);
    }

    // finalize
    lastReceiptDataUrl = receiptCanvas.toDataURL('image/jpeg', 0.92);
    photoPreview.src = lastReceiptDataUrl;
    document.getElementById('footerText').textContent = `${LOCATION_LABEL} â€¢ ${dateStr}`;

    receiptCard.style.display='block';
    previewControls.style.display='flex';
    document.getElementById('cameraWrap').style.display='none';
  };
}

/* ============================
   Draw strip (3x) - waits for all images to load
   ============================ */
async function drawReceiptStrip(photoDataUrls){
  const count = photoDataUrls.length;
  const canvasW = RECEIPT_WIDTH;
  const sidePad = 10;
  const frameH = Math.round((canvasW - sidePad*2) * 1.06); // portrait frames
  const gap = 8;
  const headerH = Math.round(canvasW*0.12);
  const footerH = Math.round(canvasW*0.22);
  const canvasH = headerH + footerH + (frameH * count) + (gap*(count-1));

  receiptCanvas.width = canvasW;
  receiptCanvas.height = canvasH;

  // background
  rcCtx.fillStyle = '#fffdf7';
  rcCtx.fillRect(0,0,canvasW,canvasH);

  // header text
  rcCtx.fillStyle = '#111';
  rcCtx.textAlign = 'center';
  rcCtx.font = `${Math.round(canvasW*0.05)}px monospace`;
  rcCtx.fillText('VIZRIZE PHOTOBOOTH', canvasW/2, Math.round(headerH*0.45));
  rcCtx.font = `${Math.round(canvasW*0.028)}px monospace`;
  rcCtx.fillText(`${LOCATION_LABEL} â€¢ Photobooth`, canvasW/2, Math.round(headerH*0.82));

  // load images
  const images = await Promise.all(photoDataUrls.map(d=>{
    return new Promise((res, rej)=>{
      const img = new Image();
      img.onload = ()=>res(img);
      img.onerror = ()=>res(null);
      img.src = d;
    });
  }));

  // draw frames stacked
  let y = headerH;
  images.forEach((img, idx)=>{
    if(img){
      rcCtx.fillStyle = '#fff';
      rcCtx.fillRect(sidePad, y, canvasW - sidePad*2, frameH);
      rcCtx.drawImage(img, sidePad + 6, y + 6, canvasW - sidePad*2 - 12, frameH - 12);
    } else {
      // placeholder
      rcCtx.fillStyle = '#f0f0f0'; rcCtx.fillRect(sidePad, y, canvasW - sidePad*2, frameH);
    }
    y += frameH + gap;
  });

  // footer
  const dateStr = new Date().toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'});
  rcCtx.fillStyle = '#111';
  rcCtx.font = `${Math.round(canvasW*0.034)}px monospace`;
  rcCtx.textAlign = 'center';
  rcCtx.fillText(`${LOCATION_LABEL} â€¢ ${dateStr}`, canvasW/2, canvasH - footerH + 28);
  rcCtx.font = `${Math.round(canvasW*0.028)}px monospace`;
  rcCtx.fillText('Scan QR untuk mengunduh foto', canvasW/2, canvasH - footerH + 60);

  // finalize
  lastReceiptDataUrl = receiptCanvas.toDataURL('image/jpeg', 0.92);
  photoPreview.src = lastReceiptDataUrl;
  document.getElementById('footerText').textContent = `${LOCATION_LABEL} â€¢ ${dateStr}`;

  receiptCard.style.display='block';
  previewControls.style.display='flex';
  document.getElementById('cameraWrap').style.display='none';
}

/* ============================
   Capture flows
   ============================ */
async function startCaptureSequence(){
  if(audioCtx.state === 'suspended') await audioCtx.resume();
  if(captureMode === 'single'){
    await countdown(3);
    playShutter(); doFlash();
    const base = captureFrameOnly();
    drawReceiptSingle(base);
  } else {
    const photos = [];
    for(let i=1;i<=3;i++){
      await countdown(3);
      playShutter(); doFlash();
      photos.push(captureFrameOnly());
      if(i<3) await new Promise(r=>setTimeout(r,600));
    }
    await drawReceiptStrip(photos);
  }
}

/* flash visual */
function doFlash(){
  flashEl.style.opacity = '0.95';
  setTimeout(()=>{ flashEl.style.opacity = '0'; }, 150);
}

/* ============================
   Cloudinary upload
   ============================ */
async function uploadToCloudinary(dataUrl){
  if(!dataUrl) throw new Error('Tidak ada gambar untuk diupload');
  const form = new FormData();
  form.append('file', dataUrl);
  form.append('upload_preset', UPLOAD_PRESET);
  // optional folder: form.append('folder','vizrize_photobooth');

  const resp = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
    method: 'POST', body: form
  });
  if(!resp.ok){
    const txt = await resp.text().catch(()=>null);
    throw new Error('Cloudinary upload gagal: ' + (txt || resp.status));
  }
  const json = await resp.json();
  if(!json.secure_url) throw new Error('Cloudinary tidak mengembalikan URL');
  return json.secure_url;
}

/* ============================
   QR + flow
   ============================ */
async function showQr(viewerUrl){
  qrcodeDiv.innerHTML = '';
  new QRCode(qrcodeDiv, { text: viewerUrl, width: 260, height: 260, correctLevel: QRCode.CorrectLevel.H });
  qrUrlEl.textContent = viewerUrl;
  qrOverlay.style.display = 'flex';
  for(let i=RETURN_SECONDS;i>0;i--){
    qrCountdownEl.textContent = `Kembali ke kamera dalam ${i} detik...`;
    await new Promise(r=>setTimeout(r,1000));
  }
  qrOverlay.style.display = 'none';
  qrcodeDiv.innerHTML = ''; qrUrlEl.textContent = ''; qrCountdownEl.textContent = '';
  receiptCard.style.display='none'; previewControls.style.display='none'; modeSelector.style.display='flex';
  document.getElementById('cameraWrap').style.display='flex';
}

/* ============================
   Buttons: upload / print
   ============================ */
printUploadBtn.addEventListener('click', async ()=>{
  try{
    processingOverlay.style.display = 'flex';
    const url = await uploadToCloudinary(lastReceiptDataUrl);
    processingOverlay.style.display = 'none';
    await showQr(url);
  }catch(e){
    processingOverlay.style.display = 'none';
    alert('Upload gagal: ' + (e.message||e));
  }
});

/* Print via Android WebView bridge (native) */
btPrintBtn.addEventListener('click', ()=>{
  // In WebView native app, implement AndroidPrinter.printImage(base64)
  if(window.AndroidPrinter && lastReceiptDataUrl){
    try{
      window.AndroidPrinter.printImage(lastReceiptDataUrl);
    }catch(e){
      alert('Gagal panggil AndroidPrinter: ' + e.message);
    }
  } else {
    alert('Fitur print Bluetooth hanya tersedia di aplikasi (WebView) dengan dukungan native.');
  }
});

/* ============================
   Utility & cleanup
   ============================ */
window.addEventListener('beforeunload', ()=>{
  const stream = video.srcObject;
  if(stream && stream.getTracks) stream.getTracks().forEach(t=>t.stop());
});

/* Allow spacebar to trigger modeSelector default (accessibility) */
window.addEventListener('keydown', (e)=>{
  if(e.code === 'Space' && modeSelector.style.display !== 'none'){
    e.preventDefault();
    singleBtn.click();
  }
});
</script>
</body>
</html>
