<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<title>VIZRIZE</title>
<script src="qrcode.min.js"></script> 
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap');

:root{
Â  --bg-dark: #1a1a1c; Â  Â  Â  Â 
Â  --bg-light: #2c2c2f; Â  Â  Â 
Â  --border-grey: #5a5a60; Â  Â 
Â  --accent-neon: #ccff00; Â  Â 
Â  --accent-sec: #00ffff; Â  Â 
Â  --text-light: #f0f0f0; Â  Â 
Â  --text-dark: #0a0a0b; Â  Â  Â 
Â  --receipt-bg: #fffdf7; Â  Â 
Â  --receipt-edge: #e6dfd4; Â 
Â Â 
Â  --header-h: 12%; Â  Â  Â 
Â  --top-area-h: 60%; Â  Â 
Â  --controls-h: 40%; Â  Â 
}

*{box-sizing:border-box}
html,body{
Â  height:100%; margin:0; overflow: hidden;
Â  font-family: 'Inter', sans-serif;
Â  background: var(--bg-dark); 
Â  color: var(--text-light);
Â  -webkit-font-smoothing:antialiased;
Â  position: fixed; width: 100%;
}

.font-mono { font-family: 'Space Mono', monospace; }

/* === 1. HEADER === */
.topHeader {
Â  /* --- PERBAIKAN CSS KASAR: Sembunyikan default, HANYA JS yang boleh menampilkan --- */
  display: none !important; 
  position: absolute;
Â  top: 0; left: 0; right: 0;
Â  height: var(--header-h);
Â  flex-direction: column;
Â  align-items: center;
Â  justify-content: center;
Â  z-index: 20;
Â  background: var(--bg-dark);
Â  border-bottom: 1px solid var(--border-grey);
Â  padding-top: env(safe-area-inset-top);
}
.badge {
Â  background: var(--accent-neon);
Â  color: var(--text-dark);
Â  padding: 2px 8px;
Â  border-radius: 4px;
Â  font-size: clamp(10px, 2vw, 12px);
Â  font-weight: 900;
Â  letter-spacing: 1px;
Â  text-transform: uppercase;
Â  margin-bottom: 4px;
}
.headerTitle {
Â  font-family: 'Space Mono', monospace;
Â  font-size: clamp(18px, 5vw, 26px);
Â  font-weight: 700;
Â  letter-spacing: -1px;
Â  color: var(--text-light);
Â  cursor: pointer; 
}

/* === 1B. WELCOME SCREEN (LANDING PAGE) === */
#welcomeScreen {
Â  /* --- FINAL FIX: Fixed position agar menutupi semua --- */
Â  position: fixed; 
Â  top: 0; left: 0; right: 0; bottom: 0; 
Â  background: var(--bg-dark);
Â  display: flex; 
Â  flex-direction: column;
Â  align-items: center;
Â  justify-content: center;
Â  z-index: 100;
}
.startCardLp {
Â  width: min(85%, 450px);
Â  text-align: center;
Â  padding: clamp(30px, 6vw, 50px);
Â  border: 2px solid var(--accent-neon);
Â  border-radius: 12px;
Â  background: rgba(0,0,0,0.4);
Â  box-shadow: 0 0 40px rgba(204, 255, 0, 0.2);
}
.lpTitle {
Â  font-family: 'Space Mono', monospace;
Â  font-size: clamp(30px, 8vw, 48px);
Â  font-weight: 700;
Â  letter-spacing: -2px;
Â  color: var(--text-light);
Â  margin: 10px 0 40px;
}
.lpBadge {
Â  font-size: clamp(14px, 3vw, 18px);
Â  font-weight: 700;
Â  color: var(--accent-neon);
}


/* === 2. KAMERA === */
#cameraWrap {
Â  display: none; 
Â  position: absolute;
Â  left: 50%;
Â  transform: translateX(-50%);
Â  top: calc(var(--header-h) + 2%); 
Â  width: 90%; 
Â  max-width: 600px; 
Â  aspect-ratio: 4 / 3; 
Â  max-height: calc(var(--top-area-h) - var(--header-h) - 20px);
Â  background: #000;
Â  z-index: 5;
Â  border: 4px solid var(--border-grey);
Â  border-radius: 8px;
Â  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
Â  overflow: hidden;
}

video#camera {
Â  width: 100%;
Â  height: 100%;
Â  object-fit: cover;
Â  transform: scaleX(-1);
}

#countdownOverlay {
Â  position: absolute;
Â  inset: 0;
Â  display: none;
Â  align-items: center;
Â  justify-content: center;
Â  background: transparent;
Â  z-index: 30;
}
#countNum { 
Â  font-size: clamp(80px, 20vw, 140px); 
Â  font-weight: 900; 
Â  color: #fff;
Â  font-family: 'Space Mono', monospace;
Â  text-shadow: 0 0 20px rgba(0,0,0,0.8), 4px 4px 0 #000;
}

/* === 3. KONTROL === */
.centerUI {
Â  display: none; 
Â  position: absolute;
Â  bottom: 0; left: 0; right: 0;
Â  height: var(--controls-h); 
Â  background: var(--bg-light); 
Â  border-top: 2px solid var(--accent-neon); 
Â  z-index: 10;
Â  flex-direction: column;
Â  align-items: center;
Â  justify-content: center;
Â  gap: clamp(15px, 3vh, 25px);
Â  padding-bottom: env(safe-area-inset-bottom);
Â  background-image: radial-gradient(#3a3a3e 15%, transparent 16%);
Â  background-size: 12px 12px;
Â  box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
}

.startCard {
Â  width: min(85%, 450px);
Â  text-align: center;
Â  padding: clamp(20px, 4vw, 30px);
Â  border: 1px dashed var(--border-grey);
Â  border-radius: 12px;
Â  background: rgba(0,0,0,0.2);
}

.controlsRowTop {
Â  display: none;
Â  gap: 15px;
Â  justify-content: center;
Â  margin-bottom: clamp(15px, 3vh, 25px);
}
.modeBtn {
Â  flex: 1;
Â  padding: clamp(12px, 2vh, 16px);
Â  border-radius: 6px;
Â  border: 1px solid var(--border-grey);
Â  background: var(--bg-dark);
Â  color: #aaa;
Â  font-family: 'Space Mono', monospace;
Â  font-weight: 700;
Â  cursor: pointer;
Â  font-size: clamp(12px, 3vw, 14px);
Â  text-transform: uppercase;
Â  transition: all 0.2s;
}
.modeBtn.selected {
Â  background: var(--text-light);
Â  color: var(--text-dark);
Â  border-color: var(--accent-neon);
Â  box-shadow: 0 0 15px rgba(204, 255, 0, 0.3);
Â  transform: translateY(-2px);
}

.startBtn {
Â  display: inline-block;
Â  width: 100%;
Â  padding: clamp(18px, 4vh, 24px);
Â  border-radius: 8px;
Â  border: 3px solid var(--accent-neon);
Â  background: transparent;
Â  color: var(--accent-neon);
Â  font-size: clamp(22px, 6vw, 32px);
Â  font-weight: 900;
Â  font-family: 'Inter', sans-serif;
Â  text-transform: uppercase;
Â  cursor: pointer;
Â  transition: all 0.1s;
Â  letter-spacing: 3px;
Â  box-shadow: inset 0 0 20px rgba(204, 255, 0, 0.1), 0 10px 20px rgba(0,0,0,0.3);
}
.startBtn:active {
Â  background: var(--accent-neon);
Â  color: var(--text-dark);
Â  transform: scale(0.98);
}
.startBtn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); box-shadow: none; }

#flash { position: fixed; inset: 0; background: #fff; opacity: 0; pointer-events: none; z-index: 100; transition: opacity 140ms ease-out; }

/* --- MODAL PREVIEW --- */
.modalOverlay { 
Â  position: fixed; inset: 0; background: rgba(0,0,0,0.95); 
Â  display: none; 
Â  align-items: center; justify-content: center; 
Â  z-index: 120; padding: 20px; backdrop-filter: blur(5px); 
}
.modalReceipt { 
Â  width: min(500px, 94vw); max-height: 85vh; overflow: auto; 
Â  background: var(--receipt-bg); border-radius: 4px; padding: 0; 
Â  font-family: 'Space Mono', monospace; color: var(--text-dark); 
Â  box-shadow: 0 0 60px rgba(0,0,0,0.9);
Â  border: 4px solid var(--bg-light);
}
.receiptInner { padding: 20px; }
.controlsRow { 
Â  display: flex; gap: 10px; justify-content: center; 
Â  padding: 20px; background: var(--bg-dark); border-top: 4px solid var(--accent-neon);
}
.action { 
Â  flex: 1; padding: 14px; border-radius: 4px; border: none; 
Â  font-weight: 700; cursor: pointer; font-size: clamp(10px, 3vw, 14px); 
Â  text-transform: uppercase; font-family: 'Space Mono', monospace;
}
.printBtn { background: var(--accent-neon); color: var(--text-dark); }
.uploadBtn { background: var(--text-light); color: var(--text-dark); }
.retakeBtn { background: transparent; color: #fff; border: 1px solid #555; }

#finalPreviewWrap { 
Â  margin: 10px 0; display: flex; justify-content: center; 
Â  min-height: 200px; 
}
.finalPreviewImg { width: 100%; display: block; border: 1px solid #ddd; }
.uploadUrl { 
Â  text-align:center; margin-top:10px; font-size:10px; 
Â  color: #999; font-family: 'Space Mono', monospace;
}

/* === QR POPUP FIXED CSS === */
#barcodePopup { 
Â  position: fixed; inset: 0; display: none; 
Â  align-items: center; justify-content: center; 
Â  z-index: 140; background: rgba(0,0,0,0.95); 
}
#barcodeBox { 
Â  width: min(600px, 90vw); 
Â  background: #111; 
Â  border: 2px solid var(--accent-neon);
Â  padding: 30px; 
Â  text-align: center; 
Â  position: relative; 
Â  color: #fff; 
Â  font-family: 'Space Mono', monospace;
}
#barcodeClose { 
Â  position: absolute; top: 10px; right: 15px; border: 0; 
Â  background: transparent; font-size: 24px; cursor: pointer; 
Â  color: #fff; 
}
#qrcodeHost { 
Â  padding: 15px; 
Â  width: 250px; 
Â  height: 250px;
Â  background: #fff; 
Â  margin: 20px auto; 
Â  border-radius: 4px;
Â  display: block; 
}
#barcodeUrlText { font-size:12px; color:#888; margin-top:10px; }

canvas { display: none; }
.stripPhoto { display: none; } 

/* Tablet Tweaks */
@media (min-width: 768px) {
Â  :root { --header-h: 10%; --top-area-h: 65%; --controls-h: 35%; }
Â  #cameraWrap { border-width: 6px; width: 94%; max-width: 1024px; }
Â  .startBtn { border-width: 5px; }
Â  .startCard { border-width: 2px; width: min(90%, 700px); }
Â  /* Tablet QR lebih besar */
Â  #qrcodeHost { width: 300px; height: 300px; } 
}
/* Small Phone Tweaks */
@media (max-width: 360px) {
Â  #qrcodeHost { width: 200px; height: 200px; }
}
</style>
</head>
<body>

<div class="topHeader" id="topHeader"> 
Â  <div class="badge">PHOTORECEIPT</div>
Â  <div class="headerTitle" id="headerTitle">VIZRIZE</div>
</div>

<div id="welcomeScreen">
Â  <div class="startCardLp">
Â  Â  <div class="lpBadge">TAP FOR FUN</div>
Â  Â  <div class="lpTitle" id="eventTitleLp">VIZRIZE PHOTOBOOTH</div>
Â  Â  <button id="startLpBtn" class="startBtn" style="letter-spacing: 5px;">TAP TO START</button>
Â  </div>
</div>

<div id="cameraWrap">
Â  <video id="camera" autoplay playsinline muted></video>
Â  <div id="countdownOverlay" aria-hidden="true">
Â  Â  <div id="countBox">
Â  Â  Â  <div id="countNum">3</div>
Â  Â  </div>
Â  </div>
</div>

<div id="flash" aria-hidden="true"></div>

<div class="centerUI" id="centerUI">
Â  <div class="startCard">
Â  Â  <div class="controlsRowTop" id="controlsRowTop">
Â  Â  Â  <button id="mode1" class="modeBtn" data-mode="single">1 STRIP</button>
Â  Â  Â  <button id="mode3" class="modeBtn" data-mode="strip">3 STRIP</button>
Â  Â  </div>
Â  Â  <button id="startBtn" class="startBtn" disabled>INITIATE</button>
Â  </div>
</div>

<div id="modalOverlay" class="modalOverlay" aria-hidden="true">
Â  <div class="modalReceipt" role="dialog" aria-modal="true" aria-labelledby="receiptLabel">
Â  Â  <div class="receiptInner" id="receiptInner">
Â  Â  Â  <div id="finalPreviewWrap"></div>
Â  Â  Â  <div class="uploadUrl" id="uploadedUrl">WAITING FOR UPLOAD...</div>
Â  Â  </div>
Â  Â  <div class="controlsRow">
Â  Â  Â  <button id="printBtn" class="action printBtn">PRINT</button>
Â  Â  Â  <button id="uploadBtn" class="action uploadBtn">UPLOAD</button>
Â  Â  Â  <button id="retakeBtn" class="action retakeBtn">RETAKE</button>
Â  Â  </div>
Â  </div>
</div>

<div id="barcodePopup" aria-hidden="true">
Â  <div id="barcodeBox">
Â  Â  <button id="barcodeClose" aria-label="Close">Ã—</button>
Â  Â  <div style="font-weight:700; letter-spacing:1px;">SCAN TO DOWNLOAD</div>
Â  Â  <div id="qrcodeHost"></div>
Â  Â  <div id="barcodeUrlText"></div>
Â  </div>
</div>

<canvas id="captureCanvas"></canvas>
<canvas id="noShadowCanvas"></canvas>
<canvas id="printCanvas"></canvas>
<canvas id="uploadShadowCanvas"></canvas>
<canvas id="ditherCanvas"></canvas>

<script>
/* ================== CONFIG ================== */
const CLOUD_NAME = "dcqqaebln";
const UPLOAD_PRESET = "vizrize_unsigned";
const PRINT_W = 384;
const FINAL_W = 1080;
const FINAL_H = 1920;
const STRIP_GAP = 8;

/* ================== DOM ================== */
const video = document.getElementById('camera');
const startBtn = document.getElementById('startBtn');
const countdownOverlay = document.getElementById('countdownOverlay');
const countNum = document.getElementById('countNum');
const flashEl = document.getElementById('flash');

const modalOverlay = document.getElementById('modalOverlay');
const finalPreviewWrap = document.getElementById('finalPreviewWrap');
const uploadedUrlEl = document.getElementById('uploadedUrl');
const uploadBtn = document.getElementById('uploadBtn');
const printBtn = document.getElementById('printBtn');
const retakeBtn = document.getElementById('retakeBtn');

const barcodePopup = document.getElementById('barcodePopup');
const barcodeClose = document.getElementById('barcodeClose');
const qrcodeHost = document.getElementById('qrcodeHost');
const barcodeUrlText = document.getElementById('barcodeUrlText');

const captureCanvas = document.getElementById('captureCanvas');
const noShadowCanvas = document.getElementById('noShadowCanvas');
const printCanvas = document.getElementById('printCanvas');
const uploadShadowCanvas = document.getElementById('uploadShadowCanvas');
const ditherCanvas = document.getElementById('ditherCanvas');

// DOM BARU UNTUK LANDING PAGE DAN KONTROL STRIP
const welcomeScreen = document.getElementById('welcomeScreen');
const startLpBtn = document.getElementById('startLpBtn');
const cameraWrap = document.getElementById('cameraWrap');
const centerUI = document.getElementById('centerUI');
const headerTitle = document.getElementById('headerTitle');
const controlsRowTop = document.getElementById('controlsRowTop');
const topHeader = document.getElementById('topHeader'); 

let captureMode = '';
let capturedCanvases = [];
let lastDitherDataUrl = null;
let lastUploadUrl = null;
let lastNoShadowCanvas = null;
let cameraReady = false;

/* ================== AUDIO (TIDAK BERUBAH) ================== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq=1000,dur=0.06){ try{ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(freq,audioCtx.currentTime); g.gain.setValueAtTime(0.06,audioCtx.currentTime); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+dur);}catch(e){}}
function speak(text){ try{ if(window.speechSynthesis){ const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);} }catch(e){}}
function shutterSound(){ beep(900,0.04); setTimeout(()=>beep(1400,0.04),70); }

/* ================== CAMERA (TIDAK BERUBAH) ================== */
async function openCamera(){
Â  try{
Â  Â  const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user', width:{ideal:1920}, height:{ideal:1080} }, audio:false });
Â  Â  video.srcObject = stream; 
Â  Â  video.addEventListener('loadedmetadata', ()=> {
Â  Â  Â  setTimeout(()=> {
Â  Â  Â  Â  if(video.videoWidth > 0 && video.videoHeight > 0){
Â  Â  Â  Â  Â  cameraReady = true;
Â  Â  Â  Â  Â  if(captureMode) startBtn.disabled = false;
Â  Â  Â  Â  }
Â  Â  Â  }, 220);
Â  Â  }, { once: true });
Â  }catch(err){
Â  Â  console.error('Camera open failed:', err);
Â  Â  alert('Cannot access camera: '+(err.message||err));
Â  }
}


document.getElementById('mode1').addEventListener('click', ()=>{ captureMode='single'; document.getElementById('mode1').classList.add('selected'); document.getElementById('mode3').classList.remove('selected'); if(cameraReady) startBtn.disabled=false; });
document.getElementById('mode3').addEventListener('click', ()=>{ captureMode='strip'; document.getElementById('mode3').classList.add('selected'); document.getElementById('mode1').classList.remove('selected'); if(cameraReady) startBtn.disabled=false; });

/* ================== CAPTURE helpers (TIDAK BERUBAH) ================== */
function captureOnce(){
Â  const vw = video.videoWidth || 0;
Â  const vh = video.videoHeight || 0;
Â  if(!vw || !vh) return null;
Â  captureCanvas.width = vw; captureCanvas.height = vh;
Â  const ctx = captureCanvas.getContext('2d');
Â  ctx.save(); ctx.scale(-1,1); ctx.drawImage(video, -vw, 0, vw, vh); ctx.restore();
Â  const out = document.createElement('canvas'); out.width = vw; out.height = vh;
Â  out.getContext('2d').drawImage(captureCanvas,0,0);
Â  return out;
}

function cropCenterTo4x3(srcCanvas, targetW){
Â  const targetH = Math.round(targetW * 3 / 4);
Â  const sw = srcCanvas.width, sh = srcCanvas.height;
Â  const srcRatio = sw/sh, tgtRatio = targetW/targetH;
Â  let sx, sy, swc, shc;
Â  if(srcRatio > tgtRatio){
Â  Â  shc = sh; swc = Math.round(shc * tgtRatio); sx = Math.floor((sw - swc)/2); sy = 0;
Â  } else {
Â  Â  swc = sw; shc = Math.round(swc / tgtRatio); sx = 0; sy = Math.floor((sh - shc)/2);
Â  }
Â  const out = document.createElement('canvas'); out.width = targetW; out.height = targetH;
Â  out.getContext('2d').drawImage(srcCanvas, sx, sy, swc, shc, 0, 0, targetW, targetH);
Â  return out;
}

function applyFintage(canvas){
Â  const ctx = canvas.getContext('2d');
Â  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
Â  const d = img.data;
Â  for(let i=0;i<d.length;i+=4){
Â  Â  const r=d[i], g=d[i+1], b=d[i+2];
Â  Â  let tr = (r*0.393 + g*0.769 + b*0.189);
Â  Â  let tg = (r*0.349 + g*0.686 + b*0.168);
Â  Â  let tb = (r*0.272 + g*0.534 + b*0.131);
Â  Â  tr = Math.min(255, ((tr-128)*1.03)+128);
Â  Â  tg = Math.min(255, ((tg-128)*1.02)+128);
Â  Â  tb = Math.min(255, ((tb-128)*0.98)+128);
Â  Â  d[i]=tr; d[i+1]=tg; d[i+2]=tb;
Â  Â  const grain = (Math.random()-0.5)*8;
Â  Â  d[i]+=grain; d[i+1]+=grain; d[i+2]+=grain;
Â  }
Â  ctx.putImageData(img,0,0);
Â  return canvas;
}

function floydDither(srcCanvas, targetWidth){
Â  const scale = targetWidth / srcCanvas.width;
Â  const tw = Math.round(srcCanvas.width * scale);
Â  const th = Math.round(srcCanvas.height * scale);
Â  ditherCanvas.width = tw; ditherCanvas.height = th;
Â  const dctx = ditherCanvas.getContext('2d');
Â  dctx.drawImage(srcCanvas, 0, 0, tw, th);
Â  const img = dctx.getImageData(0,0,tw,th);
Â  const data = img.data;
Â  const lum = new Float32Array(tw*th);
Â  for(let y=0;y<th;y++){
Â  Â  for(let x=0;x<tw;x++){
Â  Â  Â  const i=(y*tw+x)*4;
Â  Â  Â  lum[y*tw+x] = 0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2];
Â  Â  }
Â  }
Â  for(let y=0;y<th;y++){
Â  Â  for(let x=0;x<tw;x++){
Â  Â  Â  const idx = y*tw+x;
Â  Â  Â  const oldv = lum[idx];
Â  Â  Â  const newv = oldv < 128 ? 0 : 255;
Â  Â  Â  const err = oldv - newv;
Â  Â  Â  lum[idx] = newv;
Â  Â  Â  if(x+1 < tw) lum[idx+1] += err * 7/16;
Â  Â  Â  if(x-1 >=0 && y+1 < th) lum[idx + tw -1] += err * 3/16;
Â  Â  Â  if(y+1 < th) lum[idx + tw] += err * 5/16;
Â  Â  Â  if(x+1 < tw && y+1 < th) lum[idx + tw +1] += err * 1/16;
Â  Â  }
Â  }
Â  for(let y=0;y<th;y++){
Â  Â  for(let x=0;x<tw;x++){
Â  Â  Â  const i=(y*tw+x)*4;
Â  Â  Â  const v = lum[y*tw+x];
Â  Â  Â  data[i]=data[i+1]=data[i+2]=v; data[i+3]=255;
Â  Â  }
Â  }
Â  dctx.putImageData(img,0,0);
Â  return ditherCanvas.toDataURL('image/png');
}

/* ================== COMPOSE FUNCTIONS (TIDAK BERUBAH) ================== */

// 1. PREVIEW (1080p, Margin, Fixed Calculation)
function composeFinalNoShadow(captured, txId, dateStr){
Â  const canvas = noShadowCanvas;
Â  canvas.width = FINAL_W; canvas.height = FINAL_H;
Â  const ctx = canvas.getContext('2d');
Â Â 
Â  const pad = 48;
Â  const paperX = pad, paperY = pad;
Â  const paperW = FINAL_W - pad*2, paperH = FINAL_H - pad*2;
Â Â 
Â  // Define coordinates FIRST
Â  const paperBottom = paperY + paperH;
Â  const contentX = paperX + 20;
Â  const contentW = paperW - 40;
Â  const colorAbu = '#6b5c4b';
Â  const colorEdge = '#ded6c8';

Â  // Calculate Footer Positions
Â  const footerBrandY = paperBottom - 40;
Â  const footerThankY = paperBottom - 70;
Â  const footerTotalY = paperBottom - 130;
Â  const footerTaxY = footerTotalY - 34;
Â  const footerSubY = footerTaxY - 30;
Â  const footerLineY = footerSubY - 32;

Â  // Calculate Header Positions
Â  const headerY = paperY + 70;
Â  const headerLineY = headerY + 58;

Â  ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,FINAL_W,FINAL_H);
Â  ctx.fillStyle = '#fffdf7'; ctx.fillRect(paperX, paperY, paperW, paperH);

Â  // Header
Â  ctx.fillStyle = '#111'; ctx.textAlign = 'center'; ctx.font = '32px monospace';
Â  ctx.fillText('VIZRIZE PHOTOBOOTH', paperX + paperW/2, headerY);
Â  ctx.font = '16px monospace'; ctx.fillStyle = colorAbu;
Â  ctx.fillText('Jakarta â€¢ Photobooth', paperX + paperW/2, headerY + 32);
Â Â 
Â  ctx.strokeStyle = colorEdge; ctx.setLineDash([6,6]);
Â  ctx.beginPath(); ctx.moveTo(paperX + 12, headerLineY); ctx.lineTo(paperX + paperW - 12, headerLineY); ctx.stroke(); ctx.setLineDash([]);

Â  // Footer
Â  ctx.font = '18px monospace'; ctx.fillStyle = colorAbu; ctx.textAlign = 'center';
Â  ctx.fillText('THANK YOU ~ HAVE A NICE DAY!', paperX + paperW/2, footerThankY);
Â  ctx.font = '16px monospace'; ctx.fillStyle = '#111';
Â  ctx.fillText('~ PHOTORECEIPT by VizRize ~', paperX + paperW/2, footerBrandY);

Â  const subtotal = 15000; const tax = Math.round(subtotal * 0.1); const total = subtotal + tax;
Â Â 
Â  ctx.font = '18px monospace'; ctx.fillStyle = colorAbu;
Â  ctx.textAlign = 'left'; ctx.fillText('SUBTOTAL', contentX + 8, footerSubY);
Â  ctx.textAlign = 'right'; ctx.fillText('Rp' + subtotal.toLocaleString('id-ID'), contentX + contentW - 8, footerSubY);
Â Â 
Â  ctx.textAlign = 'left'; ctx.fillText('TAX (10%)', contentX + 8, footerTaxY);
Â  ctx.textAlign = 'right'; ctx.fillText('Rp' + tax.toLocaleString('id-ID'), contentX + contentW - 8, footerTaxY);
Â Â 
Â  ctx.font = '20px monospace'; ctx.fillStyle = '#111';
Â  ctx.textAlign = 'left'; ctx.fillText('TOTAL', contentX + 8, footerTotalY);
Â  ctx.textAlign = 'right'; ctx.fillText('Rp' + total.toLocaleString('id-ID'), contentX + contentW - 8, footerTotalY);

Â  ctx.setLineDash([6,6]);
Â  ctx.beginPath(); ctx.moveTo(contentX, footerLineY); ctx.lineTo(contentX + contentW, footerLineY); ctx.strokeStyle = colorEdge; ctx.stroke(); ctx.setLineDash([]);

Â  // --- PHOTO LOGIC ---
Â  const photoAreaTop = headerLineY + 20;
Â  const photoAreaBottom = footerLineY - 20;
Â  const photoAreaH = photoAreaBottom - photoAreaTop;Â 
Â  const photoW = contentW;

Â  if(captured.length === 1){
Â  Â  let imgH = photoAreaH;Â 
Â  Â  let imgW = Math.round(imgH * (4 / 3));Â 
Â  Â  if (imgW > photoW) { imgW = photoW; imgH = Math.round(imgW * (3 / 4)); }
Â  Â  const imgX = contentX + (photoW - imgW) / 2;
Â  Â  const imgY = photoAreaTop + (photoAreaH - imgH) / 2;
Â  Â  const cropped = cropCenterTo4x3(captured[0], imgW);
Â  Â  applyFintage(cropped);
Â  Â  ctx.fillStyle = '#fff'; ctx.fillRect(imgX, imgY, imgW, imgH);Â 
Â  Â  ctx.drawImage(cropped, imgX, imgY, imgW, imgH);
Â  } else {
Â  Â  // 3-STRIP SCALING
Â  Â  const idealPhotoH = Math.round(photoW * 3 / 4);
Â  Â  const totalNeededH = (idealPhotoH * captured.length) + (STRIP_GAP * (captured.length - 1));
Â  Â Â 
Â  Â  let scale = 1.0;
Â  Â  if (totalNeededH > photoAreaH) {
Â  Â  Â  Â  scale = photoAreaH / totalNeededH;Â 
Â  Â  }

Â  Â  const scaledPhotoW = photoW * scale;
Â  Â  const scaledPhotoH = idealPhotoH * scale;
Â  Â  const scaledGap = STRIP_GAP * scale;
Â  Â  const scaledTotalH = (scaledPhotoH * captured.length) + (scaledGap * (captured.length - 1));

Â  Â  let photoY = photoAreaTop + (photoAreaH - scaledTotalH) / 2;Â 
Â  Â  let photoX = contentX + (contentW - scaledPhotoW) / 2;

Â  Â  captured.forEach((c,i)=>{
Â  Â  Â  const cropped = cropCenterTo4x3(c, photoW);Â 
Â  Â  Â  applyFintage(cropped);
Â  Â  Â  ctx.fillStyle = '#fff';Â 
Â  Â  Â  ctx.fillRect(photoX, photoY, scaledPhotoW, scaledPhotoH);
Â  Â  Â  ctx.drawImage(cropped, photoX, photoY, scaledPhotoW, scaledPhotoH);
Â  Â  Â  photoY += scaledPhotoH + scaledGap;
Â  Â  });
Â  }
Â  return canvas;
}

// 2. PRINT (384px, No Margin, Big Font, Spasi Bawah)
function composeFinalForPrint(captured) {
Â  const canvas = printCanvas;Â 
Â  canvas.width = PRINT_W;Â 

Â  const headerFontSize = 26; const subHeaderFontSize = 16;
Â  const receiptFontSize = 20; const totalFontSize = 22;
Â  const footerFontSize = 16; const padding = 8;Â 
Â  const photoW = PRINT_W;Â 

Â  let photoTotalHeight = 0;
Â  if (captured.length === 1) {
Â  Â  photoTotalHeight = Math.round(photoW * (3/4));Â 
Â  } else {
Â  Â  const photoH = Math.round(photoW * (3/4));
Â  Â  photoTotalHeight = (photoH * captured.length) + (padding * (captured.length - 1));
Â  }

Â  let totalHeight = 0;
Â  totalHeight += padding;Â 
Â  totalHeight += headerFontSize;Â 
Â  totalHeight += subHeaderFontSize;Â 
Â  totalHeight += padding + 5 + padding;Â 
Â  totalHeight += photoTotalHeight;Â 
Â  totalHeight += padding + 5 + padding;Â 
Â  totalHeight += receiptFontSize + receiptFontSize + padding + totalFontSize;
Â  totalHeight += padding + 5 + padding;Â 
Â  totalHeight += footerFontSize + footerFontSize + padding;Â 
Â  totalHeight += 50;Â 

Â  canvas.height = totalHeight;
Â  const ctx = canvas.getContext('2d');
Â  ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, canvas.width, canvas.height);
Â  ctx.fillStyle = '#000000';Â 
Â Â 
Â  let currentY = 0;
Â  const leftX = 0; const rightX = canvas.width;

Â  // Header
Â  currentY += padding;
Â  ctx.font = `bold ${headerFontSize}px monospace`;
Â  ctx.textAlign = 'center';Â 
Â  ctx.fillText('VIZRIZE PHOTOBOOTH', canvas.width / 2, currentY + headerFontSize - (padding/2));
Â  currentY += headerFontSize;
Â  ctx.font = `normal ${subHeaderFontSize}px monospace`;
Â  ctx.fillText('Jakarta Photobooth', canvas.width / 2, currentY + subHeaderFontSize);
Â  currentY += subHeaderFontSize + padding;
Â Â 
Â  drawDashedLine(ctx, leftX, currentY, rightX, currentY);Â 
Â  currentY += 5 + padding;

Â  // Photo
Â  if (captured.length === 1) {
Â  Â  const photoH = Math.round(photoW * (3/4));
Â  Â  const cropped = cropCenterTo4x3(captured[0], photoW);
Â  Â  ctx.drawImage(cropped, 0, currentY, photoW, photoH);
Â  Â  currentY += photoH;
Â  } else {
Â  Â  const photoH = Math.round(photoW * (3/4));
Â  Â  captured.forEach((c, i) => {
Â  Â  Â  const cropped = cropCenterTo4x3(c, photoW);
Â  Â  Â  ctx.drawImage(cropped, 0, currentY, photoW, photoH);
Â  Â  Â  currentY += photoH;
Â  Â  Â  if (i < captured.length - 1) currentY += padding;Â 
Â  Â  });
Â  }
Â  currentY += padding;

Â  // Receipt
Â  drawDashedLine(ctx, leftX, currentY, rightX, currentY);Â 
Â  currentY += 5 + padding;

Â  const subtotal = 15000; const tax = Math.round(subtotal * 0.1); const total = subtotal + tax;
Â Â 
Â  ctx.font = `normal ${receiptFontSize}px monospace`;
Â  ctx.textAlign = 'left'; ctx.fillText('SUBTOTAL', leftX, currentY + receiptFontSize);Â 
Â  ctx.textAlign = 'right'; ctx.fillText('Rp' + subtotal.toLocaleString('id-ID'), rightX, currentY + receiptFontSize);Â 
Â  currentY += receiptFontSize;

Â  ctx.textAlign = 'left'; ctx.fillText('TAX (10%)', leftX, currentY + receiptFontSize);Â 
Â  ctx.textAlign = 'right'; ctx.fillText('Rp' + tax.toLocaleString('id-ID'), rightX, currentY + receiptFontSize);Â 
Â  currentY += receiptFontSize + padding;
Â Â 
Â  ctx.font = `bold ${totalFontSize}px monospace`;
Â  ctx.textAlign = 'left'; ctx.fillText('TOTAL', leftX, currentY + totalFontSize);Â 
Â  ctx.textAlign = 'right'; ctx.fillText('Rp' + total.toLocaleString('id-ID'), rightX, currentY + totalFontSize);Â 
Â  currentY += totalFontSize + padding;

Â  drawDashedLine(ctx, leftX, currentY, rightX, currentY);Â 
Â  currentY += 5 + padding;
Â Â 
Â  // Footer
Â  ctx.font = `normal ${footerFontSize}px monospace`;
Â  ctx.textAlign = 'center';Â 
Â  ctx.fillText('THANK YOU ~ HAVE A NICE DAY!', canvas.width / 2, currentY + footerFontSize);
Â  currentY += footerFontSize;
Â  ctx.font = `bold ${footerFontSize}px monospace`;
Â  ctx.fillText('~ PHOTORECEIPT by VizRize ~', canvas.width / 2, currentY + footerFontSize);
Â Â 
Â  return canvas;
}

function drawDashedLine(ctx, x1, y1, x2, y2) {
Â  Â  ctx.beginPath();
Â  Â  ctx.setLineDash([4, 4]);Â 
Â  Â  ctx.moveTo(x1, y1);
Â  Â  ctx.lineTo(x2, y2);
Â  Â  ctx.strokeStyle = '#000000';Â 
Â  Â  ctx.stroke();
Â  Â  ctx.setLineDash([]);Â 
}

function composeUploadWithShadow(noShadowCanvasEl){
Â  const pad = 40; const upW = noShadowCanvasEl.width + pad*2; const upH = noShadowCanvasEl.height + pad*2;
Â  const u = uploadShadowCanvas; u.width = upW; u.height = upH;
Â  const ctx = u.getContext('2d');
Â  ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,upW,upH);
Â  ctx.save(); ctx.shadowColor = 'rgba(0,0,0,0.18)'; ctx.shadowBlur = 40; ctx.shadowOffsetY = 16;
Â  const dstX = pad, dstY = pad; const r = 12;
Â  ctx.fillStyle = '#fffdf7';Â 
Â  roundRect(ctx, dstX, dstY, noShadowCanvasEl.width, noShadowCanvasEl.height, r, true, false);
Â  ctx.restore();Â 
Â  ctx.drawImage(noShadowCanvasEl, dstX, dstY);
Â  return u;
}

function roundRect(ctx, x, y, w, h, r, fill, stroke){
Â  if (typeof r === 'undefined') r = 5;
Â  ctx.beginPath(); ctx.moveTo(x + r, y); ctx.arcTo(x + w, y, x + w, y + h, r); ctx.arcTo(x + w, y + h, x, y + h, r); ctx.arcTo(x, y + h, x, y, r); ctx.arcTo(x, y, x + w, y, r); ctx.closePath();
Â  if(fill) ctx.fill(); if(stroke) ctx.stroke();
}

/* ================== FLOW (TIDAK BERUBAH) ================== */

function flashOnce(duration=140){
Â  flashEl.style.opacity = '0.95'; setTimeout(()=>{ flashEl.style.opacity = '0'; }, duration);
}

async function runCountdown(sec=3){
Â  if(audioCtx.state === 'suspended') await audioCtx.resume();
Â  countdownOverlay.style.display = 'flex';
Â  for(let i=sec;i>0;i--){
Â  Â  countNum.textContent = i;
Â  Â  speak(i.toString()); beep(1000 - (i*80), 0.12);
Â  Â  await new Promise(r=>setTimeout(r,1000));Â 
Â  }
Â  countNum.textContent = 'ðŸ“¸';
Â  speak('Click!'); shutterSound();
Â  await new Promise(r=>setTimeout(r,200));
Â  countdownOverlay.style.display = 'none';
}

async function runSession(){
Â  if(!captureMode){ alert('Pilih mode strip dulu. Klik nama event di atas.'); return; }
Â  if(!cameraReady){ alert('Camera not ready yet'); return; }
Â  capturedCanvases = [];
Â  const shots = (captureMode === 'single') ? 1 : 3;

Â  for(let i=0;i<shots;i++){
Â  Â  await runCountdown(3);
Â  Â  flashOnce(140);Â 
Â  Â  const c = captureOnce();
Â  Â  if(!c){ alert('Capture failed'); return; }
Â  Â  capturedCanvases.push(c);
Â  Â  if(i < shots - 1) await new Promise(r=>setTimeout(r,500));
Â  }

Â  preparePreviewAndFinal(capturedCanvases);
Â  modalOverlay.style.display = 'flex';
}

function preparePreviewAndFinal(captured){
Â  // Clean UI
Â  finalPreviewWrap.innerHTML = '';
Â  uploadedUrlEl.textContent = 'Not uploaded';
Â  lastDitherDataUrl = null; lastUploadUrl = null; lastNoShadowCanvas = null;

Â  const txId = 'VZ-' + Date.now().toString(36).toUpperCase().slice(-8);
Â  const dateStr = new Date().toLocaleString('en-GB', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });

Â  // 1. PREVIEW (App) - FIXED SCALING
Â  const noShadow = composeFinalNoShadow(captured, txId, dateStr);
Â  lastNoShadowCanvas = noShadow;
Â  const dataUrl = noShadow.toDataURL('image/jpeg',0.92);
Â  const img = document.createElement('img');
Â  img.src = dataUrl; img.className = 'finalPreviewImg';
Â  finalPreviewWrap.appendChild(img);

Â  // 2. PRINT (Printer) - No Margin, Big Font
Â  console.log('Membuat layout cetak (tanpa margin)...');
Â  const canvasForDither = composeFinalForPrint(captured);
Â  lastDitherDataUrl = floydDither(canvasForDither, PRINT_W);

Â  // 3. AUTO PRINT
Â  if (window.flutter_inappwebview) {
Â  Â  console.log('Memicu print otomatis...');
Â  Â  window.flutter_inappwebview.callHandler('printHandler', lastDitherDataUrl);
Â  }
}

async function uploadFinalWithShadowAndShowQr(){
Â  if(!lastNoShadowCanvas) { alert('Nothing to upload.'); return; }
Â  if(lastUploadUrl){ showQrPopup(lastUploadUrl); return; }
Â Â 
Â  uploadBtn.disabled = true; uploadBtn.textContent = 'Uploading...';
Â  try{
Â  Â  const shadowCanvas = composeUploadWithShadow(lastNoShadowCanvas);
Â  Â  const url = await uploadCanvasToCloudinary(shadowCanvas);
Â  Â  lastUploadUrl = url;
Â  Â  uploadedUrlEl.textContent = 'Uploaded: ' + url.slice(0, 40) + '...';
Â  Â  showQrPopup(url);
Â  Â  uploadBtn.textContent = 'Uploaded';
Â  }catch(err){
Â  Â  alert('Upload failed: ' + (err.message || err));
Â  Â  uploadBtn.textContent = 'â˜ï¸ Upload';
Â  } finally {
Â  Â  uploadBtn.disabled = false;Â 
Â  }
}

async function uploadCanvasToCloudinary(canvas){
Â  const dataUrl = canvas.toDataURL('image/jpeg',0.92);
Â  const blob = await (await fetch(dataUrl)).blob();
Â  const form = new FormData(); form.append('file', blob); form.append('upload_preset', UPLOAD_PRESET);Â 
Â  const resp = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: form });Â 
Â  if(!resp.ok) throw new Error('Upload failed');
Â  const json = await resp.json();
Â  return json.secure_url;
}

// REVISI: QR Popup Fix (Dimensi Pasti)
function showQrPopup(url){
Â  qrcodeHost.innerHTML = '';Â 
Â  barcodeUrlText.textContent = url;Â 
Â  barcodePopup.style.display = 'flex';Â 
Â  barcodePopup.onclick = (e)=>{ if(e.target === barcodePopup) barcodePopup.style.display = 'none'; };

Â  setTimeout(() => {
Â  Â  try {
Â  Â  Â  Â  const width = qrcodeHost.offsetWidth || 250;Â 
Â  Â  Â  Â  new QRCode(qrcodeHost, { text: url, width: width, height: width, correctLevel: QRCode.CorrectLevel.M });
Â  Â  } catch(e) {Â 
Â  Â  Â  Â  console.error(e); alert("QR Script Gagal.");Â 
Â  Â  }
Â  }, 150);
}

// --- FUNGSI BARU UNTUK TRANSISI LAYAR ---
function showControlScreen() {
  // Pindah dari Landing Page ke Control Screen
Â  welcomeScreen.style.display = 'none';
Â  topHeader.style.display = 'flex'; // Tampilkan Header
Â  cameraWrap.style.display = 'block';
Â  centerUI.style.display = 'flex';
Â  controlsRowTop.style.display = 'none'; // Sembunyikan mode strip di awal

}

// --- EVENT LISTENER BARU ---

// 1. Landing Page Start Button
startLpBtn.addEventListener('click', showControlScreen);

// 2. Header Title Click (Untuk ganti mode strip)
headerTitle.addEventListener('click', () => {
Â  // Hanya izinkan klik saat di layar kontrol (bukan di landing page atau modal)
Â  if (cameraWrap.style.display === 'block' && modalOverlay.style.display !== 'flex') {
Â  Â  // Toggle display mode strip (1 STRIP / 3 STRIP)
Â  Â  if (controlsRowTop.style.display === 'none' || controlsRowTop.style.display === '') {
Â  Â  Â  controlsRowTop.style.display = 'flex';
Â  Â  } else {
Â  Â  Â  controlsRowTop.style.display = 'none';
Â  Â  }
Â  } else if (modalOverlay.style.display === 'flex') {
    // Jika di layar modal/preview, kembali ke kontrol kamera
    modalOverlay.style.display = 'none';
    showControlScreen();
Â  } else {
    // Jika masih di landing page, abaikan klik
    return;
  }
});


// 3. Control Buttons
startBtn.addEventListener('click', runSession);
retakeBtn.addEventListener('click', async ()=>{
Â  modalOverlay.style.display = 'none';
Â  await openCamera();Â 
Â  showControlScreen(); 
});
printBtn.addEventListener('click', ()=>{
Â  if (window.flutter_inappwebview && lastDitherDataUrl) {
Â  Â  window.flutter_inappwebview.callHandler('printHandler', lastDitherDataUrl);
Â  } else {
Â  Â  alert("Print manual hanya di aplikasi");
Â  }
});
uploadBtn.addEventListener('click', uploadFinalWithShadowAndShowQr);
barcodeClose.addEventListener('click', ()=>{ barcodePopup.style.display = 'none'; });

// --- INISIASI APLIKASI (PERBAIKAN ALUR AWAL) ---
function initApp() {
Â  openCamera(); // Kamera tetap inisiasi di latar belakang

Â  // 1. Tampilkan HANYA Landing Page di awal
Â  welcomeScreen.style.display = 'flex'; 

Â  // 2. Sembunyikan SEMUA elemen operasional/modal lainnya
  topHeader.style.display = 'none'; // Sembunyikan Header
Â  cameraWrap.style.display = 'none'; 
Â  centerUI.style.display = 'none'; 
Â  modalOverlay.style.display = 'none'; 
  barcodePopup.style.display = 'none';

}
initApp(); 

</script>
</body>
</html>
