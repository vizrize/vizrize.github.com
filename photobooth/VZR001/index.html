<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Vizrize Photobooth â€” Layered Preview (Fixed)</title>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<style>
:root{
Â  --bg:#f0ede7;
Â  --muted:#2b2b2b;
Â  --accent:#111;
Â  --receipt-bg:#fffdf7;
Â  --receipt-edge:#e6dfd4;
Â  --text-abu:#6b5c4b;
Â  --upload-shadow: rgba(0,0,0,0.18);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:var(--bg);color:var(--muted);-webkit-font-smoothing:antialiased}
body{overflow:hidden}

/* Layer 1: Full-screen background video */
#cameraBg {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  transform: scaleX(-1);
  z-index: 1;
}

/* Layer 2: Semi-transparent overlay */
#cameraOverlay {
  position: fixed;
  inset: 0;
  background: rgba(255, 255, 255, 0.5);
  z-index: 2;
}

/* Layer 3: 4:3 Active Capture Area */
#cameraWrap{
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100vw; 
  height: calc(100vw * (3 / 4)); /* 4:3 Ratio */
  max-width: 100vw;
  max-height: 100vh; 
  z-index: 3; 
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}
video#camera{
  width: 100%;
  height: 100%;
  object-fit: cover;
  transform: scaleX(-1);
}

/* top branding */
.topLogo{position:fixed;top:18px;left:50%;transform:translateX(-50%);z-index:40;text-align:center;pointer-events:none}
.brand{font-weight:900;color:var(--accent);letter-spacing:1px;font-size:20px}
.subtitle{font-size:13px;color:#444;margin-top:2px}

/* center start */
.centerUI{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:42;pointer-events:none;padding:28px}
.startCard{width:min(720px,94vw);max-width:720px;text-align:center;background:rgba(255,255,255,0.96);border-radius:14px;padding:26px 20px;box-shadow:0 22px 60px rgba(0,0,0,0.16);pointer-events:auto;backdrop-filter:blur(3px);transition:opacity .45s ease, transform .45s ease}
.controlsRowTop{display:flex;gap:12px;justify-content:center;margin-bottom:14px}
.modeBtn{flex:1;padding:14px 16px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);background:#fff;font-weight:900;cursor:pointer}
.modeBtn.selected{background:linear-gradient(90deg,#fff,#faf8f6);box-shadow:0 10px 28px rgba(0,0,0,0.06)}
.startBtn{display:inline-block;padding:16px 34px;border-radius:999px;border:0;font-weight:900;background:linear-gradient(90deg,#fff,#faf8f6);color:var(--accent);font-size:20px;cursor:pointer;box-shadow:0 12px 34px rgba(0,0,0,0.14)}
.startNote{font-size:13px;color:var(--text-abu);margin-top:10px}

/* countdown */
#countdownOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:70;pointer-events:none}
#countBox{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px}
#countNum{font-size:140px;color:#fff;text-shadow:0 18px 44px rgba(0,0,0,0.5);font-weight:900;transform-origin:center;transition:all .24s}
#countLabel{color:#fff;font-weight:700;text-shadow:0 8px 18px rgba(0,0,0,0.35)}

/* flash */
#flash{position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:75;transition:opacity 140ms ease-out}

/* modal (preview) */
.modalOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.56);display:none;align-items:center;justify-content:center;z-index:120;padding:20px;backdrop-filter:blur(4px)}
.modalReceipt{width:min(500px,94vw);max-height:92vh;overflow:auto;background:linear-gradient(180deg,var(--receipt-bg),#fff8f2);border-radius:10px;box-shadow:0 22px 60px rgba(0,0,0,0.32);position:relative;border:1px solid var(--receipt-edge);font-family:'Courier New',monospace}
.tear{height:18px;background:repeating-linear-gradient(90deg,#fff 0 6px, transparent 6px 12px);border-top-left-radius:8px;border-top-right-radius:8px}
.receiptInner{padding:18px;background:#ffffff}
.headerTitle{font-weight:900;letter-spacing:1px;color:#111;font-size:18px;text-align:center}
.small{font-size:12px;color:var(--text-abu)}
.divider{height:1px;border-top:1px dashed #ded6c8;margin:10px 0}

/* photos area (dihilangkan via JS) */
.stripPhoto{width:100%;display:none;flex-direction:column;gap:6px;margin:8px 0}
.stripPhoto img{width:100%;height:auto;display:block;border:8px solid #fff;box-shadow:0 8px 28px rgba(0,0,0,0.08);object-fit:cover;border-radius:8px}

/* final preview container */
#finalPreviewWrap{display:flex;align-items:center;justify-content:center;margin:12px 0}
.finalPreviewImg{width:100%;max-width:100%;border-radius:8px;display:block;}

/* barcode popup */
#barcodePopup{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:140;background:rgba(0,0,0,0.6)}
#barcodeBox{width:min(680px,92vw);background:var(--receipt-bg);border-radius:10px;padding:18px;border:1px dashed var(--receipt-edge);box-shadow:0 26px 70px rgba(0,0,0,0.36);text-align:center}
#barcodeClose{position:absolute;top:12px;right:18px;border:0;background:transparent;font-size:22px;cursor:pointer}
#barcodeHint{color:var(--text-abu);font-size:13px;margin-bottom:8px}
#qrcodeHost{display:flex;align-items:center;justify-content:center;padding:8px}

/* controls */
.controlsRow{display:flex;gap:12px;justify-content:center;margin-top:12px;padding:14px}
.action{padding:10px 14px;border-radius:8px;border:none;font-weight:800;cursor:pointer}
.printBtn{background:#111;color:#fff}
.uploadBtn{background:#fff;border:1px solid rgba(0,0,0,0.08)}
.retakeBtn{background:#fff;border:1px solid rgba(0,0,0,0.08)}

/* hidden canvases */
canvas{display:none}

/* responsive */
@media (max-width:820px){
Â  #countNum{font-size:100px}
Â  .startCard{width:92vw;padding:20px}
Â  .headerTitle{font-size:16px}
}
</style>
</head>
<body>

<!-- Layered Camera -->
<video id="cameraBg" autoplay playsinline muted></video>
<div id="cameraOverlay" aria-hidden="true"></div>
<div id="cameraWrap"><video id="camera" autoplay playsinline muted></video></div>

<div id="flash" aria-hidden="true"></div>

<!-- branding -->
<div class="topLogo" aria-hidden="true">
Â  <div class="brand">VIZRIZE</div>
Â  <div class="subtitle">PHOTOBOOTH RECEIPT</div>
</div>

<!-- center start -->
<div class="centerUI" id="centerUI">
Â  <div class="startCard" id="startCard" role="region" aria-label="Start photobooth">
Â  Â  <div style="font-weight:900;font-size:18px;margin-bottom:6px">Vizrize Photobooth</div>
Â  Â  <div class="controlsRowTop">
Â  Â  Â  <button id="mode1" class="modeBtn" data-mode="single">ğŸ“¸ 1 Strip</button>
Â  Â  Â  <button id="mode3" class="modeBtn" data-mode="strip">ğŸ“¸ 3 Strip</button>
Â  Â  </div>
Â  Â  <button id="startBtn" class="startBtn" disabled>Start</button>
Â  Â  <div class="startNote">Choose mode â†’ press Start â†’ follow countdown</div>
Â  </div>
</div>

<!-- countdown -->
<div id="countdownOverlay" aria-hidden="true">
Â  <div id="countBox">
Â  Â  <div id="countNum">3</div>
Â  Â  <div id="countLabel">Get Ready</div>
Â  </div>
</div>

<!-- preview modal -->
<div id="modalOverlay" class="modalOverlay" aria-hidden="true">
Â  <div class="modalReceipt" role="dialog" aria-modal="true" aria-labelledby="receiptLabel">
Â  Â  <div class="tear" aria-hidden="true"></div>
Â  Â  <div class="receiptInner" id="receiptInner">
Â  Â  Â  <div style="text-align:center">
Â  Â  Â  Â  <div class="headerTitle" id="receiptLabel">VIZRIZE PHOTOBOOTH</div>
Â  Â  Â  Â  <div class="small" id="receiptSub">Jakarta Â· Photobooth</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="divider"></div>

Â  Â  Â  <div class="stripPhoto" id="stripPhoto"></div>
Â  Â  Â  <div class="divider" id="stripDivider" style="display:none"></div>

Â  Â  Â  <div id="finalPreviewWrap"></div>

Â  Â  Â  <div class="divider"></div>

Â  Â  Â  <div class="uploadUrl" id="uploadedUrl">Not uploaded</div>
Â  Â  </div>
Â  Â  <div class="tear" aria-hidden="true"></div>

Â  Â  <div class="controlsRow">
Â  Â  Â  <button id="printBtn" class="action printBtn">ğŸ–¨ï¸ Print</button>
Â  Â  Â  <button id="uploadBtn" class="action uploadBtn">â˜ï¸ Upload</button>
Â  Â  Â  <button id="retakeBtn" class="action retakeBtn">â†©ï¸ Retake</button>
Â  Â  </div>
Â  </div>
</div>

<!-- QR popup -->
<div id="barcodePopup" aria-hidden="true">
Â  <div id="barcodeBox">
Â  Â  <button id="barcodeClose" aria-label="Close">Ã—</button>
Â  Â  <div style="font-weight:900;margin-bottom:8px">SCAN RESULT</div>
Â  Â  <div id="barcodeHint">Scan to view / download</div>
Â  Â  <div id="qrcodeHost"></div>
Â  Â  <div id="barcodeUrlText" style="font-size:12px;color:var(--text-abu);word-break:break-all;max-width:90%;margin:auto"></div>
Â  </div>
</div>

<!-- hidden canvases -->
<canvas id="captureCanvas"></canvas>
<canvas id="noShadowCanvas"></canvas>
<canvas id="printCanvas"></canvas>    <canvas id="uploadShadowCanvas"></canvas>
<canvas id="ditherCanvas"></canvas>

<script>
/* ================== CONFIG ================== */
const CLOUD_NAME = "dcqqaebln";
const UPLOAD_PRESET = "vizrize_unsigned";
const PRINT_W = 384;
const FINAL_W = 1080;
const FINAL_H = 1920;
const STRIP_GAP = 8;

/* ================== DOM ================== */
const video = document.getElementById('camera');
const videoBg = document.getElementById('cameraBg'); 
const cameraOverlay = document.getElementById('cameraOverlay'); 
const startBtn = document.getElementById('startBtn');
const startCard = document.getElementById('startCard');
const countdownOverlay = document.getElementById('countdownOverlay');
const countNum = document.getElementById('countNum');
const countLabel = document.getElementById('countLabel');
const flashEl = document.getElementById('flash');

const modalOverlay = document.getElementById('modalOverlay');
const stripPhoto = document.getElementById('stripPhoto');
const stripDivider = document.getElementById('stripDivider');
const finalPreviewWrap = document.getElementById('finalPreviewWrap');
const uploadedUrlEl = document.getElementById('uploadedUrl');
const uploadBtn = document.getElementById('uploadBtn');
const printBtn = document.getElementById('printBtn');
const retakeBtn = document.getElementById('retakeBtn');

const barcodePopup = document.getElementById('barcodePopup');
const barcodeClose = document.getElementById('barcodeClose');
const qrcodeHost = document.getElementById('qrcodeHost');
const barcodeUrlText = document.getElementById('barcodeUrlText');

const captureCanvas = document.getElementById('captureCanvas');
const noShadowCanvas = document.getElementById('noShadowCanvas');
const uploadShadowCanvas = document.getElementById('uploadShadowCanvas');
const ditherCanvas = document.getElementById('ditherCanvas');
const printCanvas = document.getElementById('printCanvas'); // <-- TAMBAHKAN BARIS INI

let captureMode = '';
let capturedCanvases = [];
let lastDitherDataUrl = null;
let lastUploadUrl = null;
let lastNoShadowCanvas = null;
let cameraReady = false;

/* ================== AUDIO ================== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq=1000,dur=0.06){ try{ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(freq,audioCtx.currentTime); g.gain.setValueAtTime(0.06,audioCtx.currentTime); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+dur);}catch(e){}}
function speak(text){ try{ if(window.speechSynthesis){ const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);} }catch(e){}}
function shutterSound(){ beep(900,0.04); setTimeout(()=>beep(1400,0.04),70); }

/* ================== CAMERA ================== */
async function openCamera(){
Â  try{
Â  Â  const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user', width:{ideal:1920}, height:{ideal:1080} }, audio:false });
Â  Â  video.srcObject = stream; // 4:3 active preview
    videoBg.srcObject = stream; // full-screen background

Â  Â  video.addEventListener('loadedmetadata', ()=> {
Â  Â  Â  setTimeout(()=> {
Â  Â  Â  Â  if(video.videoWidth > 0 && video.videoHeight > 0){
Â  Â  Â  Â  Â  cameraReady = true;
Â  Â  Â  Â  Â  if(captureMode) startBtn.disabled = false;
Â  Â  Â  Â  }
Â  Â  Â  }, 220);
Â  Â  }, { once: true });
Â  }catch(err){
Â  Â  console.error('Camera open failed:', err);
Â  Â  alert('Cannot access camera: '+(err.message||err));
Â  }
}
openCamera();

document.getElementById('mode1').addEventListener('click', ()=>{ captureMode='single'; document.getElementById('mode1').classList.add('selected'); document.getElementById('mode3').classList.remove('selected'); if(cameraReady) startBtn.disabled=false; });
document.getElementById('mode3').addEventListener('click', ()=>{ captureMode='strip'; document.getElementById('mode3').classList.add('selected'); document.getElementById('mode1').classList.remove('selected'); if(cameraReady) startBtn.disabled=false; });

/* ================== CAPTURE helpers ================== */
function captureOnce(){
Â  const vw = video.videoWidth || 0;
Â  const vh = video.videoHeight || 0;
Â  if(!vw || !vh) return null;
Â  captureCanvas.width = vw; captureCanvas.height = vh;
Â  const ctx = captureCanvas.getContext('2d');
Â  ctx.save(); ctx.scale(-1,1); ctx.drawImage(video, -vw, 0, vw, vh); ctx.restore();
Â  const out = document.createElement('canvas'); out.width = vw; out.height = vh;
Â  out.getContext('2d').drawImage(captureCanvas,0,0);
Â  return out;
}

function cropCenterTo4x3(srcCanvas, targetW){
Â  const targetH = Math.round(targetW * 3 / 4);
Â  const sw = srcCanvas.width, sh = srcCanvas.height;
Â  const srcRatio = sw/sh, tgtRatio = targetW/targetH;
Â  let sx, sy, swc, shc;
Â  if(srcRatio > tgtRatio){
Â  Â  shc = sh; swc = Math.round(shc * tgtRatio); sx = Math.floor((sw - swc)/2); sy = 0;
Â  } else {
Â  Â  swc = sw; shc = Math.round(swc / tgtRatio); sx = 0; sy = Math.floor((sh - shc)/2);
Â  }
Â  const out = document.createElement('canvas'); out.width = targetW; out.height = targetH;
Â  out.getContext('2d').drawImage(srcCanvas, sx, sy, swc, shc, 0, 0, targetW, targetH);
Â  return out;
}

function applyFintage(canvas){
Â  const ctx = canvas.getContext('2d');
Â  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
Â  const d = img.data;
Â  for(let i=0;i<d.length;i+=4){
Â  Â  const r=d[i], g=d[i+1], b=d[i+2];
Â  Â  let tr = (r*0.393 + g*0.769 + b*0.189);
Â  Â  let tg = (r*0.349 + g*0.686 + b*0.168);
Â  Â  let tb = (r*0.272 + g*0.534 + b*0.131);
Â  Â  tr = Math.min(255, ((tr-128)*1.03)+128);
Â  Â  tg = Math.min(255, ((tg-128)*1.02)+128);
Â  Â  tb = Math.min(255, ((tb-128)*0.98)+128);
Â  Â  d[i]=tr; d[i+1]=tg; d[i+2]=tb;
Â  Â  const grain = (Math.random()-0.5)*8;
Â  Â  d[i]+=grain; d[i+1]+=grain; d[i+2]+=grain;
Â  }
Â  ctx.putImageData(img,0,0);
Â  return canvas;
}

function floydDither(srcCanvas, targetWidth){
Â  const scale = targetWidth / srcCanvas.width;
Â  const tw = Math.round(srcCanvas.width * scale);
Â  const th = Math.round(srcCanvas.height * scale);
Â  ditherCanvas.width = tw; ditherCanvas.height = th;
Â  const dctx = ditherCanvas.getContext('2d');
Â  dctx.drawImage(srcCanvas, 0, 0, tw, th);
Â  const img = dctx.getImageData(0,0,tw,th);
Â  const data = img.data;
Â  const lum = new Float32Array(tw*th);
Â  for(let y=0;y<th;y++){
Â  Â  for(let x=0;x<tw;x++){
Â  Â  Â  const i=(y*tw+x)*4;
Â  Â  Â  lum[y*tw+x] = 0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2];
Â  Â  }
Â  }
Â  for(let y=0;y<th;y++){
Â  Â  for(let x=0;x<tw;x++){
Â  Â  Â  const idx = y*tw+x;
Â  Â  Â  const oldv = lum[idx];
Â  Â  Â  const newv = oldv < 128 ? 0 : 255;
Â  Â  Â  const err = oldv - newv;
Â  Â  Â  lum[idx] = newv;
Â  Â  Â  if(x+1 < tw) lum[idx+1] += err * 7/16;
Â  Â  Â  if(x-1 >=0 && y+1 < th) lum[idx + tw -1] += err * 3/16;
Â  Â  Â  if(y+1 < th) lum[idx + tw] += err * 5/16;
Â  Â  Â  if(x+1 < tw && y+1 < th) lum[idx + tw +1] += err * 1/16;
Â  Â  }
Â  }
Â  for(let y=0;y<th;y++){
Â  Â  for(let x=0;x<tw;x++){
Â  Â  Â  const i=(y*tw+x)*4;
Â  Â  Â  const v = lum[y*tw+x];
Â  Â  Â  data[i]=data[i+1]=data[i+2]=v; data[i+3]=255;
Â  Â  }
Â  }
Â  dctx.putImageData(img,0,0);
Â  return ditherCanvas.toDataURL('image/png');
}

/* ================== Compose final canvases ================== */

/* --- REVISI 3 & 4 (FIXED 3-STRIP SCALING) --- */
function composeFinalNoShadow(captured, txId, dateStr){
Â  const canvas = noShadowCanvas;
Â  canvas.width = FINAL_W; canvas.height = FINAL_H;
Â  const ctx = canvas.getContext('2d');
Â  
Â  const pad = 48;
Â  const paperX = pad, paperY = pad;
Â  const paperW = FINAL_W - pad*2, paperH = FINAL_H - pad*2;
Â  const paperBottom = paperY + paperH;
Â  const contentX = paperX + 20;
Â  const contentW = paperW - 40;
Â  const leftX = contentX + 8;
Â  const rightX = contentX + contentW - 8;
Â  const colorAbu = '#6b5c4b';
Â  const colorEdge = '#ded6c8';

Â  ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,FINAL_W,FINAL_H);
Â  ctx.fillStyle = '#fffdf7'; 
Â  ctx.fillRect(paperX, paperY, paperW, paperH);

Â  // 3. Draw Header (Always visible)
Â  ctx.fillStyle = '#111'; ctx.textAlign = 'center'; ctx.font = '32px monospace';
Â  const headerY = paperY + 70;
Â  ctx.fillText('VIZRIZE PHOTOBOOTH', paperX + paperW/2, headerY);
Â  ctx.font = '16px monospace'; ctx.fillStyle = colorAbu;
Â  ctx.fillText('Jakarta â€¢ Photobooth', paperX + paperW/2, headerY + 32);
Â  const headerLineY = headerY + 58;
Â  ctx.strokeStyle = colorEdge; ctx.setLineDash([6,6]);
Â  ctx.beginPath(); ctx.moveTo(paperX + 12, headerLineY); ctx.lineTo(paperX + paperW - 12, headerLineY); ctx.stroke(); ctx.setLineDash([]);

Â  // 4. Draw Footer (Always visible)
Â  const footerBrandY = paperBottom - 40;
Â  const footerThankY = paperBottom - 70;
Â  const footerTotalY = paperBottom - 130;
Â  const footerTaxY = footerTotalY - 34;
Â  const footerSubY = footerTaxY - 30;
Â  const footerLineY = footerSubY - 32;

Â  ctx.font = '18px monospace'; ctx.fillStyle = colorAbu; ctx.textAlign = 'center';
Â  ctx.fillText('THANK YOU ~ HAVE A NICE DAY!', paperX + paperW/2, footerThankY);
Â  ctx.font = '16px monospace'; ctx.fillStyle = '#111';
Â  ctx.fillText('~ PHOTORECEIPT by VizRize ~', paperX + paperW/2, footerBrandY);

Â  const subtotal = 15000;
Â  const tax = Math.round(subtotal * 0.1);
Â  const total = subtotal + tax;

Â  ctx.font = '18px monospace'; ctx.fillStyle = colorAbu;
Â  ctx.textAlign = 'left'; ctx.fillText('SUBTOTAL', leftX, footerSubY);
Â  ctx.textAlign = 'right'; ctx.fillText('Rp' + subtotal.toLocaleString('id-ID'), rightX, footerSubY);

Â  ctx.textAlign = 'left'; ctx.fillText('TAX (10%)', leftX, footerTaxY);
Â  ctx.textAlign = 'right'; ctx.fillText('Rp' + tax.toLocaleString('id-ID'), rightX, footerTaxY);

Â  ctx.font = '20px monospace'; ctx.fillStyle = '#111';
Â  ctx.textAlign = 'left'; ctx.fillText('TOTAL', leftX, footerTotalY);
Â  ctx.textAlign = 'right'; ctx.fillText('Rp' + total.toLocaleString('id-ID'), rightX, footerTotalY);

Â  ctx.setLineDash([6,6]);
Â  ctx.beginPath(); ctx.moveTo(contentX, footerLineY); ctx.lineTo(contentX + contentW, footerLineY); ctx.strokeStyle = colorEdge; ctx.stroke(); ctx.setLineDash([]);

Â  // 5. Draw Photos (Calculates fit-in logic)
Â  const photoAreaTop = headerLineY + 20;
Â  const photoAreaBottom = footerLineY - 20;
Â  const photoAreaH = photoAreaBottom - photoAreaTop; // Available height
Â  const photoW = contentW; // Available width

Â  if(captured.length === 1){
    // 1-STRIP LOGIC (Smaller Margins)
Â  Â  let imgH = photoAreaH; 
Â  Â  let imgW = Math.round(imgH * (4 / 3)); 
    
    if (imgW > photoW) {
        imgW = photoW; 
        imgH = Math.round(imgW * (3 / 4)); 
    }
    
Â  Â  const imgX = contentX + (photoW - imgW) / 2;
Â  Â  const imgY = photoAreaTop + (photoAreaH - imgH) / 2;

Â  Â  const cropped = cropCenterTo4x3(captured[0], imgW);
Â  Â  applyFintage(cropped);
Â  Â  ctx.fillStyle = '#fff'; 
    ctx.fillRect(imgX, imgY, imgW, imgH); 
Â  Â  ctx.drawImage(cropped, imgX, imgY, imgW, imgH);

Â  } else {
    // 3-STRIP LOGIC (Fit-in Scaling)
    const photoH_unscaled = Math.round(photoW * 3 / 4);
    const totalPhotoH_unscaled = (photoH_unscaled * captured.length) + (STRIP_GAP * (captured.length - 1));

    let scale = 1.0;
    if (totalPhotoH_unscaled > photoAreaH) {
      scale = photoAreaH / totalPhotoH_unscaled;
    }

    const photoW_scaled = Math.round(photoW * scale);
    const photoH_scaled = Math.round(photoH_unscaled * scale);
    const gap_scaled = Math.round(STRIP_GAP * scale);

    const totalPhotoH_scaled = (photoH_scaled * captured.length) + (gap_scaled * (captured.length - 1));

    let photoY = photoAreaTop + (photoAreaH - totalPhotoH_scaled) / 2; // Center block vertically
    let photoX = contentX + (contentW - photoW_scaled) / 2; // Center block horizontally
Â  Â  
Â  Â  captured.forEach((c,i)=>{
Â  Â  Â  const cropped = cropCenterTo4x3(c, photoW); // Crop at high res
Â  Â  Â  applyFintage(cropped);
Â  Â  Â  ctx.fillStyle = '#fff'; 
      ctx.fillRect(photoX, photoY, photoW_scaled, photoH_scaled);
Â  Â  Â  ctx.drawImage(cropped, photoX, photoY, photoW_scaled, photoH_scaled); // Draw scaled
Â  Â  Â  photoY += photoH_scaled + gap_scaled;
Â  Â  });
Â  }
Â  
Â  return canvas;
}


/* uploadShadowCanvas: builds a slightly larger canvas containing noShadow canvas centered with shadow */
function composeUploadWithShadow(noShadowCanvasEl){
Â  const pad = 40; 
Â  const upW = noShadowCanvasEl.width + pad*2;
Â  const upH = noShadowCanvasEl.height + pad*2;
Â  const u = uploadShadowCanvas;
Â  u.width = upW; u.height = upH;
Â  const ctx = u.getContext('2d');

Â  ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,upW,upH);

Â  ctx.save();
Â  ctx.shadowColor = 'rgba(0,0,0,0.18)';
Â  ctx.shadowBlur = 40;
Â  ctx.shadowOffsetY = 16;
Â  const dstX = pad, dstY = pad;
Â  const r = 12;
Â  ctx.fillStyle = '#fffdf7'; 
Â  roundRect(ctx, dstX, dstY, noShadowCanvasEl.width, noShadowCanvasEl.height, r, true, false);
  ctx.restore(); 
Â  
  ctx.drawImage(noShadowCanvasEl, dstX, dstY);

Â  return u;
}

/* helper: rounded rect */
function roundRect(ctx, x, y, w, h, r, fill, stroke){
Â  if (typeof r === 'undefined') r = 5;
Â  ctx.beginPath();
Â  ctx.moveTo(x + r, y);
Â  ctx.arcTo(x + w, y, x + w, y + h, r);
Â  ctx.arcTo(x + w, y + h, x, y + h, r);
Â  ctx.arcTo(x, y + h, x, y, r);
Â  ctx.arcTo(x, y, x + w, y, r);
Â  ctx.closePath(); // <-- FIXED
Â  if(fill) ctx.fill();
Â  if(stroke) ctx.stroke();
}
/* ================== Compose Canvas KHUSUS CETAK (REVISI FINAL) ================== */
/*
  Fungsi ini membuat gambar BARU khusus untuk printer
  - Lebar 384px (PRINT_W), TANPA margin kiri/kanan
  - Teks LEBIH BESAR dan Jelas (Hitam pekat)
  - Menggambar DETAIL STRUK (Subtotal, Tax, Total)
  - Mengatur layout 1-strip atau 3-strip secara otomatis
*/
function composeFinalForPrint(captured) {
  const canvas = printCanvas; // Menggunakan kanvas cetak
  canvas.width = PRINT_W; // 384px

  // --- Font besar agar jelas di printer ---
  const headerFontSize = 26;
  const subHeaderFontSize = 16;
  const receiptFontSize = 20;
  const totalFontSize = 22;
  const footerFontSize = 16;
  const padding = 8; // Jarak 8px
  const photoW = PRINT_W; // Lebar penuh, X=0, tanpa margin

  // --- 1. Hitung Tinggi Foto ---
  let photoTotalHeight = 0;
  if (captured.length === 1) {
    photoTotalHeight = Math.round(photoW * (3/4)); // 4:3
  } else {
    const photoH = Math.round(photoW * (3/4));
    photoTotalHeight = (photoH * captured.length) + (padding * (captured.length - 1));
  }

  // --- 2. Hitung Total Tinggi Canvas ---
  let totalHeight = 0;
  totalHeight += padding; // Jarak atas
  totalHeight += headerFontSize; // "VIZRIZE PHOTOBOOTH"
  totalHeight += subHeaderFontSize; // "Jakarta Photobooth"
  totalHeight += padding; // Jarak ke dashed line
  totalHeight += 5; // Dashed line
  totalHeight += padding; // Jarak ke foto
  totalHeight += photoTotalHeight; // Blok Foto
  totalHeight += padding; // Jarak ke dashed line
  totalHeight += 5; // Dashed line
  totalHeight += padding; // Jarak ke subtotal
  totalHeight += receiptFontSize; // Subtotal
  totalHeight += receiptFontSize; // Tax
  totalHeight += padding; // Jarak ke total
  totalHeight += totalFontSize; // Total
  totalHeight += padding; // Jarak ke dashed line
  totalHeight += 5; // Dashed line
  totalHeight += padding; // Jarak ke thank you
  totalHeight += footerFontSize; // "THANK YOU"
  totalHeight += footerFontSize; // "PHOTORECEIPT"
  totalHeight += padding; // Jarak bawah

  // --- 3. Set Canvas dan Mulai Menggambar ---
  canvas.height = totalHeight;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#000000'; // Teks hitam pekat (agar tidak di-dither)
  
  let currentY = 0;
  const leftX = 0; // REVISI: Margin kiri adalah 0
  const rightX = canvas.width; // REVISI: Margin kanan adalah 0

// --- 4. Gambar Header (REVISI: Rata Tengah) ---
currentY += padding;
ctx.font = `bold ${headerFontSize}px monospace`;
ctx.textAlign = 'center'; // KEMBALIKAN ke 'center'
ctx.fillText('VIZRIZE PHOTOBOOTH', canvas.width / 2, currentY + headerFontSize - (padding/2)); // KEMBALIKAN ke 'canvas.width / 2'
currentY += headerFontSize;

ctx.font = `normal ${subHeaderFontSize}px monospace`;
ctx.textAlign = 'center'; // KEMBALIKAN ke 'center'
ctx.fillText('Jakarta Photobooth', canvas.width / 2, currentY + subHeaderFontSize); // KEMBALIKAN ke 'canvas.width / 2'
currentY += subHeaderFontSize + padding;
Â  
drawDashedLine(ctx, leftX, currentY, rightX, currentY); // Dashed line (full-width)
currentY += 5 + padding;
  // --- 5. Gambar Foto (Full-width) ---
  if (captured.length === 1) {
    const photoH = Math.round(photoW * (3/4));
    const cropped = cropCenterTo4x3(captured[0], photoW);
    ctx.drawImage(cropped, 0, currentY, photoW, photoH);
    currentY += photoH;
  } else {
    const photoH = Math.round(photoW * (3/4));
    captured.forEach((c, i) => {
      const cropped = cropCenterTo4x3(c, photoW);
      ctx.drawImage(cropped, 0, currentY, photoW, photoH);
      currentY += photoH;
      if (i < captured.length - 1) currentY += padding; // Jarak 8px antar foto
    });
  }
  currentY += padding;

  // --- 6. Gambar Footer (Detail Receipt) ---
  drawDashedLine(ctx, leftX, currentY, rightX, currentY); // Dashed line (full-width)
  currentY += 5 + padding;

  const subtotal = 15000;
  const tax = Math.round(subtotal * 0.1);
  const total = subtotal + tax;
  
  ctx.font = `normal ${receiptFontSize}px monospace`;
  ctx.textAlign = 'left';
  ctx.fillText('SUBTOTAL', leftX, currentY + receiptFontSize); // X=0
  ctx.textAlign = 'right';
  ctx.fillText('Rp' + subtotal.toLocaleString('id-ID'), rightX, currentY + receiptFontSize); // X=384
  currentY += receiptFontSize;

  ctx.textAlign = 'left';
  ctx.fillText('TAX (10%)', leftX, currentY + receiptFontSize); // X=0
  ctx.textAlign = 'right';
  ctx.fillText('Rp' + tax.toLocaleString('id-ID'), rightX, currentY + receiptFontSize); // X=384
  currentY += receiptFontSize + padding;
  
  ctx.font = `bold ${totalFontSize}px monospace`;
  ctx.textAlign = 'left';
  ctx.fillText('TOTAL', leftX, currentY + totalFontSize); // X=0
  ctx.textAlign = 'right';
  ctx.fillText('Rp' + total.toLocaleString('id-ID'), rightX, currentY + totalFontSize); // X=384
  currentY += totalFontSize + padding;

  drawDashedLine(ctx, leftX, currentY, rightX, currentY); // Dashed line (full-width)
  currentY += 5 + padding;
  
  ctx.font = `normal ${footerFontSize}px monospace`;
  ctx.textAlign = 'center'; // Teks footer boleh tengah lagi
  ctx.fillText('THANK YOU ~ HAVE A NICE DAY!', canvas.width / 2, currentY + footerFontSize);
  currentY += footerFontSize;
  ctx.font = `bold ${footerFontSize}px monospace`;
  ctx.fillText('~ PHOTORECEIPT by VizRize ~', canvas.width / 2, currentY + footerFontSize);
  
  return canvas;
}

// Helper function untuk garis putus-putus
function drawDashedLine(ctx, x1, y1, x2, y2) {
    ctx.beginPath();
    ctx.setLineDash([4, 4]); // 4px garis, 4px spasi
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.strokeStyle = '#000000'; // Hitam pekat
    ctx.stroke();
    ctx.setLineDash([]); // Reset
}
/* ================== Flow: preview, upload, print ================== */

function flashOnce(duration=140){
Â  flashEl.style.opacity = '0.95';
Â  setTimeout(()=>{ flashEl.style.opacity = '0'; }, duration);
}

async function runCountdown(sec=3){
Â  if(audioCtx.state === 'suspended') await audioCtx.resume();
Â  startCard.style.transition = 'opacity .35s ease, transform .35s ease';
Â  startCard.style.opacity = '0';
Â  startCard.style.transform = 'translateY(12px) scale(.98)';
Â  countdownOverlay.style.display = 'flex';
Â  for(let i=sec;i>0;i--){
Â  Â  countNum.textContent = i;
Â  Â  countLabel.textContent = 'Get Ready';
Â  Â  countNum.style.transform = 'scale(1.12)';
Â  Â  speak(i.toString());
Â  Â  beep(1000 - (i*80), 0.12);
Â  Â  await new Promise(r=>setTimeout(r,360));
Â  Â  countNum.style.transform = 'scale(1)';
Â  Â  await new Promise(r=>setTimeout(r,640));
Â  }
Â  countNum.textContent = 'ğŸ“¸';
Â  countLabel.textContent = 'Click!';
Â  speak('Click!');
Â  shutterSound();
Â  await new Promise(r=>setTimeout(r,420));
Â  countdownOverlay.style.display = 'none';
Â  startCard.style.display = 'none'; // <-- FIXED
}

async function runSession(){
Â  if(!captureMode){ alert('Select mode first'); return; }
Â  if(!cameraReady){ alert('Camera not ready yet â€” wait and try Start.'); return; }
Â  capturedCanvases = [];
Â  const shots = (captureMode === 'single') ? 1 : 3;

Â  for(let i=0;i<shots;i++){
Â  Â  await runCountdown(3);
Â  Â  flashOnce(140); shutterSound(); await new Promise(r=>setTimeout(r,120));
Â  Â  if(!video.videoWidth || !video.videoHeight) await new Promise(r=>setTimeout(r,250));
Â  Â  const c = captureOnce();
Â  Â  if(!c){ alert('Capture failed â€” camera not ready.'); startCard.style.display='block'; startCard.style.opacity='1'; startCard.style.transform='translateY(0)'; return; }
Â  Â  capturedCanvases.push(c);
Â  Â  if(i < shots - 1) await new Promise(r=>setTimeout(r,360));
Â  }

Â  stopCameraAndShowWhite();
Â  preparePreviewAndFinal(capturedCanvases);
Â  modalOverlay.style.display = 'flex';
}

function stopCameraAndShowWhite(){
  // REVISI 1: Stop both streams
Â  try{
Â  Â  const stream = video.srcObject; // Get stream from active video
Â  Â  if(stream && stream.getTracks) stream.getTracks().forEach(t=>t.stop());
    video.srcObject = null;
    videoBg.srcObject = null;
Â  }catch(e){}
  
  // Sembunyikan semua layer kamera
Â  document.getElementById('cameraWrap').style.display = 'none'; 
Â  videoBg.style.display = 'none';
  cameraOverlay.style.display = 'none';
}

async function restartCamera(){
Â  try{
    // REVISI 1: Tampilkan lagi semua layer kamera
    document.getElementById('cameraWrap').style.display = 'block'; 
Â    videoBg.style.display = 'block';
    cameraOverlay.style.display = 'block';

Â  Â  const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user', width:{ideal:1920}, height:{ideal:1080} }, audio:false });
Â  Â  video.srcObject = stream;
    videoBg.srcObject = stream;
Â  }catch(err){
Â  Â  console.warn('restart camera failed', err);
Â  }
}

/* build preview (no shadow) and set up final canvases */
function preparePreviewAndFinal(captured){
  // --- (Bagian clear UI Anda tetap sama) ---
  stripPhoto.innerHTML = ''; 
  stripPhoto.style.display = 'none'; 
  stripDivider.style.display = 'none'; 
  finalPreviewWrap.innerHTML = '';
  uploadedUrlEl.textContent = 'Not uploaded';
  lastDitherDataUrl = null;
  lastUploadUrl = null; 
  lastNoShadowCanvas = null;
  // ----------------------------------------

  const txId = 'VZ-' + Date.now().toString(36).toUpperCase().slice(-8);
  const dateStr = new Date().toLocaleString('en-GB', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });

  // === 1. BUAT PREVIEW MODAL (TIDAK DIUBAH) ===
  // Ini tetap 1080x1920, cantik, ada margin.
  const noShadow = composeFinalNoShadow(captured, txId, dateStr);
  lastNoShadowCanvas = noShadow; // Ini HANYA untuk PREVIEW MODAL

  // Tampilkan preview di modal
  try{
    const dataUrl = noShadow.toDataURL('image/jpeg',0.92);
    const img = document.createElement('img');
    img.src = dataUrl;
    img.className = 'finalPreviewImg';
    finalPreviewWrap.innerHTML = '';
    finalPreviewWrap.appendChild(img);
  }catch(e){
    console.warn('preview image creation failed', e);
  }

  // === 2. BUAT GAMBAR UNTUK CETAK (REVISI) ===
  // Panggil fungsi BARU kita yang serbaguna (untuk 1-strip ATAU 3-strip)
  console.log('Membuat layout cetak (tanpa margin, font besar)...');
  const canvasForDither = composeFinalForPrint(captured); // <--- BARIS KUNCI

  // === 3. BUAT DITHER DARI KANVAS YANG TEPAT ===
  lastDitherDataUrl = floydDither(canvasForDither, PRINT_W); 

  // === 4. KIRIM DATA DITHER KE PRINTER (Otomatis) ===
  if (window.flutter_inappwebview) {
    console.log('Memicu print otomatis dengan gambar dither...');
    // Kirim data yang sudah di-dither dan di-layout dengan benar
    window.flutter_inappwebview.callHandler('printHandler', lastDitherDataUrl);
  }
}// <--- AKHIR FUNGSI
/* ================== Upload & QR popup ================== */

async function uploadFinalWithShadowAndShowQr(){
Â  if(!lastNoShadowCanvas) { alert('Nothing to upload.'); return; }
Â  if(lastUploadUrl){ 
    showQrPopup(lastUploadUrl);
    return;
  }
  
  uploadBtn.disabled = true; uploadBtn.textContent = 'Uploading...';
Â  try{
Â  Â  const shadowCanvas = composeUploadWithShadow(lastNoShadowCanvas);
Â  Â  const url = await uploadCanvasToCloudinary(shadowCanvas);
Â  Â  lastUploadUrl = url;
Â  Â  uploadedUrlEl.textContent = 'Uploaded: ' + url.slice(0, 40) + '...';
Â  Â  showQrPopup(url);
Â  Â  uploadBtn.textContent = 'Uploaded';
Â  }catch(err){
Â  Â  alert('Upload failed: ' + (err.message || err));
Â  Â  uploadBtn.textContent = 'â˜ï¸ Upload';
Â  } finally {
Â  Â  uploadBtn.disabled = false; 
Â  }
}

async function uploadCanvasToCloudinary(canvas){
Â  const dataUrl = canvas.toDataURL('image/jpeg',0.92);
Â  const blob = await (await fetch(dataUrl)).blob();
Â  const form = new FormData(); form.append('file', blob); form.append('upload_preset', UPLOAD_PRESET); 
Â  const resp = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: form }); 
Â  if(!resp.ok){
Â  Â  const txt = await resp.text().catch(()=>null);
Â  Â  throw new Error('Upload failed: ' + (txt || resp.status));
Â  }
Â  const json = await resp.json();
Â  if(!json.secure_url) throw new Error('No secure_url returned');
Â  return json.secure_url;
}

function showQrPopup(url){
Â  qrcodeHost.innerHTML = '';
Â  new QRCode(qrcodeHost, { text: url, width: 250, height: 250, correctLevel: QRCode.CorrectLevel.M });
Â  barcodeUrlText.textContent = url; 
Â  barcodePopup.style.display = 'flex';
Â  barcodePopup.onclick = (e)=>{ if(e.target === barcodePopup) barcodePopup.style.display = 'none'; };
}

/* ================== Events ================== */
startBtn.addEventListener('click', ()=>{ runSession(); });

retakeBtn.addEventListener('click', async ()=>{
Â  modalOverlay.style.display = 'none';
Â  capturedCanvases = []; lastUploadUrl = null; lastNoShadowCanvas = null; lastDitherDataUrl = null;
Â  uploadedUrlEl.textContent = 'Not uploaded';
  uploadBtn.textContent = 'â˜ï¸ Upload'; 
Â  
Â  await restartCamera(); 
Â  
  startCard.style.display = 'block';
Â  startCard.style.transition = 'none'; 
Â  await new Promise(r=>setTimeout(r,10)); 
Â  startCard.style.opacity = '1';
Â  startCard.style.transform = 'translateY(0)';
});

printBtn.addEventListener('click', ()=>{
  if (window.flutter_inappwebview) {
    // BENAR: Kirim 'lastDitherDataUrl'
    if (lastDitherDataUrl) {
        window.flutter_inappwebview.callHandler('printHandler', lastDitherDataUrl);
    } else {
        alert('No dithered image ready.');
    }
  } else {
    // ... (kode window.open untuk web) ...
Â  Â  if(lastDitherDataUrl){
Â  Â  Â  const w = window.open(); w.document.body.style.margin = '0';
Â  Â  Â  const img = w.document.createElement('img'); img.src = lastDitherDataUrl; img.style.width='100%';
Â  Â  Â  w.document.body.appendChild(img);
Â  Â  } else alert('No printable image ready.');
  }
});

uploadBtn.addEventListener('click', async ()=>{
Â  await uploadFinalWithShadowAndShowQr();
});

barcodeClose.addEventListener('click', ()=>{ barcodePopup.style.display = 'none'; });

window.addEventListener('keydown',(e)=>{ 
  if(e.code==='Space' && !startBtn.disabled && startCard.style.opacity === '1'){ 
    e.preventDefault(); 
    startBtn.click(); 
  } 
});

window.addEventListener('beforeunload', ()=>{ 
  try{
Â  Â  const stream = video.srcObject;
Â  Â  if(stream && stream.getTracks) stream.getTracks().forEach(t=>t.stop());
    video.srcObject = null;
    videoBg.srcObject = null;
Â  }catch(e){} 
});

</script>
</body>
</html>
