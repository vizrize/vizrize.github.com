<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Vizrize Photobooth â€” Final (9:16 Portrait)</title>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<style>
:root{
Â  --bg:#f0ede7;
Â  --muted:#2b2b2b;
Â  --accent:#111;
Â  --receipt-bg:#fffdf7;
Â  --receipt-edge:#e6dfd4;
Â  --text-abu:#6b5c4b;
Â  --upload-shadow: rgba(0,0,0,0.18);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;background:var(--bg);color:var(--muted);-webkit-font-smoothing:antialiased}
body{overflow:hidden}

/* camera background */
#cameraWrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:1}
video#camera{width:100vw;height:100vh;object-fit:cover;transform:scaleX(-1);}

/* top branding */
.topLogo{position:fixed;top:18px;left:50%;transform:translateX(-50%);z-index:40;text-align:center;pointer-events:none}
.brand{font-weight:900;color:var(--accent);letter-spacing:1px;font-size:20px}
.subtitle{font-size:13px;color:#444;margin-top:2px}

/* center start */
.centerUI{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:42;pointer-events:none;padding:28px}
.startCard{width:min(720px,94vw);max-width:720px;text-align:center;background:rgba(255,255,255,0.96);border-radius:14px;padding:26px 20px;box-shadow:0 22px 60px rgba(0,0,0,0.16);pointer-events:auto;backdrop-filter:blur(3px);transition:opacity .45s ease, transform .45s ease}
.controlsRowTop{display:flex;gap:12px;justify-content:center;margin-bottom:14px}
.modeBtn{flex:1;padding:14px 16px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);background:#fff;font-weight:900;cursor:pointer}
.modeBtn.selected{background:linear-gradient(90deg,#fff,#faf8f6);box-shadow:0 10px 28px rgba(0,0,0,0.06)}
.startBtn{display:inline-block;padding:16px 34px;border-radius:999px;border:0;font-weight:900;background:linear-gradient(90deg,#fff,#faf8f6);color:var(--accent);font-size:20px;cursor:pointer;box-shadow:0 12px 34px rgba(0,0,0,0.14)}
.startNote{font-size:13px;color:var(--text-abu);margin-top:10px}

/* countdown */
#countdownOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:70;pointer-events:none}
#countBox{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px}
#countNum{font-size:140px;color:#fff;text-shadow:0 18px 44px rgba(0,0,0,0.5);font-weight:900;transform-origin:center;transition:all .24s}
#countLabel{color:#fff;font-weight:700;text-shadow:0 8px 18px rgba(0,0,0,0.35)}

/* flash */
#flash{position:fixed;inset:0;background:#fff;opacity:0;pointer-events:none;z-index:75;transition:opacity 140ms ease-out}

/* modal (preview) */
.modalOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.56);display:none;align-items:center;justify-content:center;z-index:120;padding:20px;backdrop-filter:blur(4px)}
/* --- PERBAIKAN 2.2: Modal diubah agar lebih besar di tablet --- */
.modalReceipt{width:min(500px,94vw);max-height:92vh;overflow:auto;background:linear-gradient(180deg,var(--receipt-bg),#fff8f2);border-radius:10px;box-shadow:0 22px 60px rgba(0,0,0,0.32);position:relative;border:1px solid var(--receipt-edge);font-family:'Courier New',monospace}
.tear{height:18px;background:repeating-linear-gradient(90deg,#fff 0 6px, transparent 6px 12px);border-top-left-radius:8px;border-top-right-radius:8px}
.receiptInner{padding:18px;background:#ffffff} /* white preview area */
.headerTitle{font-weight:900;letter-spacing:1px;color:#111;font-size:18px;text-align:center}
.small{font-size:12px;color:var(--text-abu)}
.divider{height:1px;border-top:1px dashed #ded6c8;margin:10px 0}

/* photos area */
.stripPhoto{width:100%;display:flex;flex-direction:column;gap:6px;margin:8px 0}
.stripPhoto img{width:100%;height:auto;display:block;border:8px solid #fff;box-shadow:0 8px 28px rgba(0,0,0,0.08);object-fit:cover;border-radius:8px}

/* itemized area (receipt text, abu-abu) */
/* .itemList DIHAPUS DARI HTML */

/* final preview container (no shadow for modal) */
#finalPreviewWrap{display:flex;align-items:center;justify-content:center;margin:12px 0}
/* --- PERBAIKAN 2.2: max-width diubah agar preview besar --- */
.finalPreviewImg{width:100%;max-width:100%;border-radius:8px;display:block;}

/* barcode popup */
#barcodePopup{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:140;background:rgba(0,0,0,0.6)}
#barcodeBox{width:min(680px,92vw);background:var(--receipt-bg);border-radius:10px;padding:18px;border:1px dashed var(--receipt-edge);box-shadow:0 26px 70px rgba(0,0,0,0.36);text-align:center}
#barcodeClose{position:absolute;top:12px;right:18px;border:0;background:transparent;font-size:22px;cursor:pointer}
#barcodeHint{color:var(--text-abu);font-size:13px;margin-bottom:8px}
#qrcodeHost{display:flex;align-items:center;justify-content:center;padding:8px}

/* controls */
.controlsRow{display:flex;gap:12px;justify-content:center;margin-top:12px;padding:14px}
.action{padding:10px 14px;border-radius:8px;border:none;font-weight:800;cursor:pointer}
.printBtn{background:#111;color:#fff}
.uploadBtn{background:#fff;border:1px solid rgba(0,0,0,0.08)}
.retakeBtn{background:#fff;border:1px solid rgba(0,0,0,0.08)}

/* hidden canvases */
canvas{display:none}

/* responsive */
@media (max-width:820px){
Â  #countNum{font-size:100px}
Â  .startCard{width:92vw;padding:20px}
Â  .headerTitle{font-size:16px}
Â  /* --- PERBAIKAN 2.2: Aturan max-width finalPreviewImg dihapus --- */
}
</style>
</head>
<body>

<div id="cameraWrap"><video id="camera" autoplay playsinline muted></video></div>
<div id="flash" aria-hidden="true"></div>

<div class="topLogo" aria-hidden="true">
Â  <div class="brand">VIZRIZE</div>
Â  <div class="subtitle">PHOTOBOOTH RECEIPT</div>
</div>

<div class="centerUI" id="centerUI">
Â  <div class="startCard" id="startCard" role="region" aria-label="Start photobooth">
Â  Â  <div style="font-weight:900;font-size:18px;margin-bottom:6px">Vizrize Photobooth</div>
Â  Â  <div class="controlsRowTop">
Â  Â  Â  <button id="mode1" class="modeBtn" data-mode="single">ğŸ“¸ 1 Strip</button>
Â  Â  Â  <button id="mode3" class="modeBtn" data-mode="strip">ğŸ“¸ 3 Strip</button>
Â  Â  </div>
Â  Â  <button id="startBtn" class="startBtn" disabled>Start</button>
Â  Â  <div class="startNote">Choose mode â†’ press Start â†’ follow countdown</div>
Â  </div>
</div>

<div id="countdownOverlay" aria-hidden="true">
Â  <div id="countBox">
Â  Â  <div id="countNum">3</div>
Â  Â  <div id="countLabel">Get Ready</div>
Â  </div>
</div>

<div id="modalOverlay" class="modalOverlay" aria-hidden="true">
Â  <div class="modalReceipt" role="dialog" aria-modal="true" aria-labelledby="receiptLabel">
Â  Â  <div class="tear" aria-hidden="true"></div>
Â  Â  <div class="receiptInner" id="receiptInner">
Â  Â  Â  <div style="text-align:center">
Â  Â  Â  Â  <div class="headerTitle" id="receiptLabel">VIZRIZE PHOTOBOOTH</div>
Â  Â  Â  Â  <div class="small" id="receiptSub">Jakarta Â· Photobooth</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="divider"></div>

      Â  Â  Â  <div class="stripPhoto" id="stripPhoto"></div>

Â  Â  Â  <div class="divider"></div>

      Â  Â  Â  <div id="finalPreviewWrap"></div>

Â  Â  Â  <div class="divider"></div>

      Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="uploadUrl" id="uploadedUrl">Not uploaded</div>
Â  Â  </div>
Â  Â  <div class="tear" aria-hidden="true"></div>

Â  Â  <div class="controlsRow">
Â  Â  Â  <button id="printBtn" class="action printBtn">ğŸ–¨ï¸ Print</button>
Â  Â  Â  <button id="uploadBtn" class="action uploadBtn">â˜ï¸ Upload</button>
Â  Â  Â  <button id="retakeBtn" class="action retakeBtn">â†©ï¸ Retake</button>
Â  Â  </div>
Â  </div>
</div>

<div id="barcodePopup" aria-hidden="true">
Â  <div id="barcodeBox">
Â  Â  <button id="barcodeClose" aria-label="Close">Ã—</button>
Â  Â  <div style="font-weight:900;margin-bottom:8px">SCAN RESULT</div>
Â  Â  <div id="barcodeHint">Scan to view / download</div>
Â  Â  <div id="qrcodeHost"></div>
Â  Â  <div id="barcodeUrlText" style="font-size:12px;color:var(--text-abu);word-break:break-all;max-width:90%;margin:auto"></div>
Â  </div>
</div>

<canvas id="captureCanvas"></canvas>Â  Â  Â  Â  Â <canvas id="noShadowCanvas"></canvas>Â  Â  Â  Â  <canvas id="uploadShadowCanvas"></canvas>Â  Â  <canvas id="ditherCanvas"></canvas>Â  Â  Â  Â  Â  <script>
/* ================== CONFIG ================== */
const CLOUD_NAME = "dcqqaebln";
const UPLOAD_PRESET = "vizrize_unsigned";
const PRINT_W = 384;Â  Â  Â  Â  Â  Â // thermal width for dithering
const FINAL_W = 1080;Â  Â  Â  Â  Â // final portrait width
const FINAL_H = 1920;Â  Â  Â  Â  Â // final portrait height
const STRIP_GAP = 8; // Sedikit diperbesar dari 6

/* ================== DOM ================== */
const video = document.getElementById('camera');
const startBtn = document.getElementById('startBtn');
const startCard = document.getElementById('startCard');
const countdownOverlay = document.getElementById('countdownOverlay');
const countNum = document.getElementById('countNum');
const countLabel = document.getElementById('countLabel');
const flashEl = document.getElementById('flash');

const modalOverlay = document.getElementById('modalOverlay');
const stripPhoto = document.getElementById('stripPhoto');
const finalPreviewWrap = document.getElementById('finalPreviewWrap');
// const itemList = document.getElementById('itemList'); // <-- Dihapus
const uploadedUrlEl = document.getElementById('uploadedUrl');
const uploadBtn = document.getElementById('uploadBtn');
const printBtn = document.getElementById('printBtn');
const retakeBtn = document.getElementById('retakeBtn');

const barcodePopup = document.getElementById('barcodePopup');
const barcodeClose = document.getElementById('barcodeClose');
const qrcodeHost = document.getElementById('qrcodeHost');
const barcodeUrlText = document.getElementById('barcodeUrlText');

const captureCanvas = document.getElementById('captureCanvas');
const noShadowCanvas = document.getElementById('noShadowCanvas');
const uploadShadowCanvas = document.getElementById('uploadShadowCanvas');
const ditherCanvas = document.getElementById('ditherCanvas');

let captureMode = ''; // 'single' or 'strip'
let capturedCanvases = [];
let lastDitherDataUrl = null;
let lastUploadUrl = null;
let lastNoShadowCanvas = null;
let cameraReady = false;

/* ================== AUDIO ================== */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq=1000,dur=0.06){ try{ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(freq,audioCtx.currentTime); g.gain.setValueAtTime(0.06,audioCtx.currentTime); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+dur);}catch(e){}}
function speak(text){ try{ if(window.speechSynthesis){ const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);} }catch(e){}}
function shutterSound(){ beep(900,0.04); setTimeout(()=>beep(1400,0.04),70); }

/* ================== CAMERA ================== */
async function openCamera(){
Â  try{
Â  Â  const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user', width:{ideal:1920}, height:{ideal:1080} }, audio:false });
Â  Â  video.srcObject = stream;
Â  Â  video.addEventListener('loadedmetadata', ()=> {
Â  Â  Â  setTimeout(()=> {
Â  Â  Â  Â  if(video.videoWidth > 0 && video.videoHeight > 0){
Â  Â  Â  Â  Â  cameraReady = true;
Â  Â  Â  Â  Â  if(captureMode) startBtn.disabled = false;
Â  Â  Â  Â  }
Â  Â  Â  }, 220);
Â  Â  }, { once: true });
Â  }catch(err){
Â  Â  console.error('Camera open failed:', err);
Â  Â  alert('Cannot access camera: '+(err.message||err));
Â  }
}
openCamera();

document.getElementById('mode1').addEventListener('click', ()=>{ captureMode='single'; document.getElementById('mode1').classList.add('selected'); document.getElementById('mode3').classList.remove('selected'); if(cameraReady) startBtn.disabled=false; });
document.getElementById('mode3').addEventListener('click', ()=>{ captureMode='strip'; document.getElementById('mode3').classList.add('selected'); document.getElementById('mode1').classList.remove('selected'); if(cameraReady) startBtn.disabled=false; });

/* ================== CAPTURE helpers ================== */
function captureOnce(){
Â  const vw = video.videoWidth || 0;
Â  const vh = video.videoHeight || 0;
Â  if(!vw || !vh) return null;
Â  captureCanvas.width = vw; captureCanvas.height = vh;
Â  const ctx = captureCanvas.getContext('2d');
Â  ctx.save(); ctx.scale(-1,1); ctx.drawImage(video, -vw, 0, vw, vh); ctx.restore();
Â  const out = document.createElement('canvas'); out.width = vw; out.height = vh;
Â  out.getContext('2d').drawImage(captureCanvas,0,0);
Â  return out;
}

/* crop center to 4:3 width target */
function cropCenterTo4x3(srcCanvas, targetW){
Â  const targetH = Math.round(targetW * 3 / 4);
Â  const sw = srcCanvas.width, sh = srcCanvas.height;
Â  const srcRatio = sw/sh, tgtRatio = targetW/targetH;
Â  let sx, sy, swc, shc;
Â  if(srcRatio > tgtRatio){
Â  Â  shc = sh; swc = Math.round(shc * tgtRatio); sx = Math.floor((sw - swc)/2); sy = 0;
Â  } else {
Â  Â  swc = sw; shc = Math.round(swc / tgtRatio); sx = 0; sy = Math.floor((sh - shc)/2);
Â  }
Â  const out = document.createElement('canvas'); out.width = targetW; out.height = targetH;
Â  out.getContext('2d').drawImage(srcCanvas, sx, sy, swc, shc, 0, 0, targetW, targetH);
Â  return out;
}

/* simple fintage filter */
function applyFintage(canvas){
Â  const ctx = canvas.getContext('2d');
Â  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
Â  const d = img.data;
Â  for(let i=0;i<d.length;i+=4){
Â  Â  const r=d[i], g=d[i+1], b=d[i+2];
Â  Â  let tr = (r*0.393 + g*0.769 + b*0.189);
Â  Â  let tg = (r*0.349 + g*0.686 + b*0.168);
Â  Â  let tb = (r*0.272 + g*0.534 + b*0.131);
Â  Â  tr = Math.min(255, ((tr-128)*1.03)+128);
Â  Â  tg = Math.min(255, ((tg-128)*1.02)+128);
Â  Â  tb = Math.min(255, ((tb-128)*0.98)+128);
Â  Â  d[i]=tr; d[i+1]=tg; d[i+2]=tb;
Â  Â  const grain = (Math.random()-0.5)*8;
Â  Â  d[i]+=grain; d[i+1]+=grain; d[i+2]+=grain;
Â  }
Â  ctx.putImageData(img,0,0);
Â  return canvas;
}

/* floydâ€“steinberg dither for thermal */
function floydDither(srcCanvas, targetWidth){
Â  const scale = targetWidth / srcCanvas.width;
Â  const tw = Math.round(srcCanvas.width * scale);
Â  const th = Math.round(srcCanvas.height * scale);
Â  ditherCanvas.width = tw; ditherCanvas.height = th;
Â  const dctx = ditherCanvas.getContext('2d');
Â  dctx.drawImage(srcCanvas, 0, 0, tw, th);
Â  const img = dctx.getImageData(0,0,tw,th);
Â  const data = img.data;
Â  const lum = new Float32Array(tw*th);
Â  for(let y=0;y<th;y++){
Â  Â  for(let x=0;x<tw;x++){
Â  Â  Â  const i=(y*tw+x)*4;
Â  Â  Â  lum[y*tw+x] = 0.299*data[i] + 0.587*data[i+1] + 0.114*data[i+2];
Â  Â  }
Â  }
Â  for(let y=0;y<th;y++){
Â  Â  for(let x=0;x<tw;x++){
Â  Â  Â  const idx = y*tw+x;
Â  Â  Â  const oldv = lum[idx];
Â  Â  Â  const newv = oldv < 128 ? 0 : 255;
Â  Â  Â  const err = oldv - newv;
Â  Â  Â  lum[idx] = newv;
Â  Â  Â  if(x+1 < tw) lum[idx+1] += err * 7/16;
Â  Â  Â  if(x-1 >=0 && y+1 < th) lum[idx + tw -1] += err * 3/16;
Â  Â  Â  if(y+1 < th) lum[idx + tw] += err * 5/16;
Â  Â  Â  if(x+1 < tw && y+1 < th) lum[idx + tw +1] += err * 1/16;
play: }
Â  }
Â  for(let y=0;y<th;y++){
Â  Â  for(let x=0;x<tw;x++){
Â  Â  Â  const i=(y*tw+x)*4;
Â  Â  Â  const v = lum[y*tw+x];
Â  Â  Â  data[i]=data[i+1]=data[i+2]=v; data[i+3]=255;
Â  Â  }
Â  }
Â  dctx.putImageData(img,0,0);
Â  return ditherCanvas.toDataURL('image/png');
}

/* ================== Compose final canvases ================== */

/* --- PERBAIKAN 1.3, 1.5, 3.5: Fungsi ini ditulis ulang agar proporsional --- */
/* noShadowCanvas: final 1080x1920 portrait, white background, header + photos + footer (real struk) */
function composeFinalNoShadow(captured, txId, dateStr){
Â  const canvas = noShadowCanvas;
Â  canvas.width = FINAL_W; canvas.height = FINAL_H;
Â  const ctx = canvas.getContext('2d');
Â  
Â  // 1. Setup layout constants
Â  const pad = 48;
Â  const paperX = pad, paperY = pad;
Â  const paperW = FINAL_W - pad*2, paperH = FINAL_H - pad*2;
Â  const paperBottom = paperY + paperH;
Â  const contentX = paperX + 20;
Â  const contentW = paperW - 40;
Â  const leftX = contentX + 8;
Â  const rightX = contentX + contentW - 8;
Â  const colorAbu = '#6b5c4b';
Â  const colorEdge = '#ded6c8';

Â  // 2. Draw background
Â  ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,FINAL_W,FINAL_H);
Â  ctx.fillStyle = '#fffdf7'; // warna struk (var --receipt-bg)
Â  ctx.fillRect(paperX, paperY, paperW, paperH);

Â  // 3. Draw Header
Â  ctx.fillStyle = '#111'; ctx.textAlign = 'center'; ctx.font = '32px monospace';
Â  const headerY = paperY + 70;
Â  ctx.fillText('VIZRIZE PHOTOBOOTH', paperX + paperW/2, headerY);
Â  ctx.font = '16px monospace'; ctx.fillStyle = colorAbu;
Â  ctx.fillText('Jakarta â€¢ Photobooth', paperX + paperW/2, headerY + 32);
Â  const headerLineY = headerY + 58;
Â  ctx.strokeStyle = colorEdge; ctx.setLineDash([6,6]);
Â  ctx.beginPath(); ctx.moveTo(paperX + 12, headerLineY); ctx.lineTo(paperX + paperW - 12, headerLineY); ctx.stroke(); ctx.setLineDash([]);

Â  // 4. Draw Footer (from bottom-up) - Ini memperbaiki proporsi
Â  const footerBrandY = paperBottom - 40;
Â  const footerThankY = paperBottom - 70;
Â  const footerTotalY = paperBottom - 130;
Â  const footerTaxY = footerTotalY - 34;
Â  const footerSubY = footerTaxY - 30;
Â  const footerLineY = footerSubY - 32;

Â  // Footer text (Item 3.5)
Â  ctx.font = '18px monospace'; ctx.fillStyle = colorAbu; ctx.textAlign = 'center';
Â  ctx.fillText('THANK YOU ~ HAVE A NICE DAY!', paperX + paperW/2, footerThankY);
Â  ctx.font = '16px monospace'; ctx.fillStyle = '#111';
Â  ctx.fillText('~ PHOTORECEIPT by VizRize ~', paperX + paperW/2, footerBrandY);

Â  // Footer totals
Â  const subtotal = 15000;
Â  const tax = Math.round(subtotal * 0.1);
Â  const total = subtotal + tax;

Â  ctx.font = '18px monospace'; ctx.fillStyle = colorAbu;
Â  ctx.textAlign = 'left'; ctx.fillText('SUBTOTAL', leftX, footerSubY);
Â  ctx.textAlign = 'right'; ctx.fillText('Rp' + subtotal.toLocaleString('id-ID'), rightX, footerSubY);

Â  ctx.textAlign = 'left'; ctx.fillText('TAX (10%)', leftX, footerTaxY);
Â  ctx.textAlign = 'right'; ctx.fillText('Rp' + tax.toLocaleString('id-ID'), rightX, footerTaxY);

Â  ctx.font = '20px monospace'; ctx.fillStyle = '#111';
Â  ctx.textAlign = 'left'; ctx.fillText('TOTAL', leftX, footerTotalY);
ctx.textAlign = 'right'; ctx.fillText('Rp' + total.toLocaleString('id-ID'), rightX, footerTotalY);

Â  // Footer divider
Â  ctx.setLineDash([6,6]);
Â  ctx.beginPath(); ctx.moveTo(contentX, footerLineY); ctx.lineTo(contentX + contentW, footerLineY); ctx.strokeStyle = colorEdge; ctx.stroke(); ctx.setLineDash([]);

Â  // 5. Draw Photos (di ruang sisa, agar proporsional - Item 1.5)
Â  const photoAreaTop = headerLineY + 20;
Â  const photoAreaBottom = footerLineY - 20;
Â  const photoAreaH = photoAreaBottom - photoAreaTop;
Â  const photoW = contentW;
Â  const photoH = Math.round(photoW * 3 / 4);

Â  if(captured.length === 1){
Â  Â  // Pusatkan 1 foto secara vertikal
Â  Â  const photoY = photoAreaTop + (photoAreaH - photoH) / 2;
Â  Â  const cropped = cropCenterTo4x3(captured[0], photoW);
Â  Â  applyFintage(cropped);
Â  Â  ctx.fillStyle = '#fff'; ctx.fillRect(contentX, photoY, photoW, photoH);
Â  Â  ctx.drawImage(cropped, contentX, photoY, photoW, photoH);
Â  } else {
Â  Â  // Pusatkan blok 3 foto secara vertikal
Â  Â  const totalPhotoH = (photoH * captured.length) + (STRIP_GAP * (captured.length - 1));
Â  Â  let photoY = photoAreaTop + (photoAreaH - totalPhotoH) / 2;
Â  Â  
Â  Â  captured.forEach((c,i)=>{
Â  Â  Â  const cropped = cropCenterTo4x3(c, photoW);
Â  Â  Â  applyFintage(cropped);
Â  Â  Â  ctx.fillStyle = '#fff'; ctx.fillRect(contentX, photoY, photoW, photoH);
Â  Â  Â  ctx.drawImage(cropped, contentX, photoY, photoW, photoH);
Â  Â  Â  photoY += photoH + STRIP_GAP;
Â  Â  });
Â  }
Â  
Â  return canvas;
}


/* uploadShadowCanvas: builds a slightly larger canvas containing noShadow canvas centered with shadow */
function composeUploadWithShadow(noShadowCanvasEl){
Â  // create an upload canvas slightly bigger to allow shadow bleed
Â  const pad = 40; // extra space for shadow
Â  const upW = noShadowCanvasEl.width + pad*2;
Â  const upH = noShadowCanvasEl.height + pad*2;
Â  const u = uploadShadowCanvas;
Â  u.width = upW; u.height = upH;
Â  const ctx = u.getContext('2d');

Â  // white background
Â  ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,upW,upH);

Â  // apply shadow for the paper (shadow is part of image)
Â  ctx.save();
Â  ctx.shadowColor = 'rgba(0,0,0,0.18)';
Â  ctx.shadowBlur = 40;
Â  ctx.shadowOffsetY = 16;
Â  // draw paper background rectangle (slightly inset)
Â  const dstX = pad, dstY = pad;
Â  // draw a rounded rect for nicer look
Â  const r = 12;
Â  ctx.fillStyle = '#fffdf7'; // var(--receipt-bg)
Â  roundRect(ctx, dstX, dstY, noShadowCanvasEl.width, noShadowCanvasEl.height, r, true, false);
  ctx.restore(); // Restore *sebelum* menggambar canvas, agar canvas-nya tidak kena shadow ganda
Â  
  // draw the noShadow canvas onto this paper
Â  ctx.drawImage(noShadowCanvasEl, dstX, dstY);

Â  return u;
}

/* helper: rounded rect */
function roundRect(ctx, x, y, w, h, r, fill, stroke){
Â  if (typeof r === 'undefined') r = 5;
Â  ctx.beginPath();
Â  ctx.moveTo(x + r, y);
Â  ctx.arcTo(x + w, y, x + w, y + h, r);
Â  ctx.arcTo(x + w, y + h, x, y + h, r);
Â  ctx.arcTo(x, y + h, x, y, r);
Â  ctx.arcTo(x, y, x + w, y, r);
Â  ctx.closePath();
Â  if(fill) ctx.fill();
Â  if(stroke) ctx.stroke();
}

/* ================== Flow: preview, upload, print ================== */

/* flash animation */
function flashOnce(duration=140){
Â  flashEl.style.opacity = '0.95';
Â  setTimeout(()=>{ flashEl.style.opacity = '0'; }, duration);
}

/* countdown */
async function runCountdown(sec=3){
Â  if(audioCtx.state === 'suspended') await audioCtx.resume();
Â  startCard.style.transition = 'opacity .35s ease, transform .35s ease';
Â  startCard.style.opacity = '0';
Â  startCard.style.transform = 'translateY(12px) scale(.98)';
Â  countdownOverlay.style.display = 'flex';
Â  for(let i=sec;i>0;i--){
Â  Â  countNum.textContent = i;
Â  Â  countLabel.textContent = 'Get Ready';
Â  Â  countNum.style.transform = 'scale(1.12)';
Â  Â  speak(i.toString());
Â  Â  beep(1000 - (i*80), 0.12);
Â  Â  await new Promise(r=>setTimeout(r,360));
Â  Â  countNum.style.transform = 'scale(1)';
Â  Â  await new Promise(r=>setTimeout(r,640));
Â  }
Â  countNum.textContent = 'ğŸ“¸';
Â  countLabel.textContent = 'Click!';
Â  speak('Click!');
Â  shutterSound();
Â  await new Promise(r=>setTimeout(r,420));
Â  countdownOverlay.style.display = 'none';
Â  startCard.style.display = 'none';
}

/* run session: captures then shows modal preview (no shadow) */
async function runSession(){
Â  if(!captureMode){ alert('Select mode first'); return; }
Â  if(!cameraReady){ alert('Camera not ready yet â€” wait and try Start.'); return; }
Â  capturedCanvases = [];
Â  const shots = (captureMode === 'single') ? 1 : 3;

Â  for(let i=0;i<shots;i++){
Â  Â  await runCountdown(3);
Â  Â  flashOnce(140); shutterSound(); await new Promise(r=>setTimeout(r,120));
Â  Â  if(!video.videoWidth || !video.videoHeight) await new Promise(r=>setTimeout(r,250));
Â  Â  const c = captureOnce();
Â  Â  if(!c){ alert('Capture failed â€” camera not ready.'); startCard.style.display='block'; startCard.style.opacity='1'; startCard.style.transform='translateY(0)'; return; }
Â  Â  capturedCanvases.push(c);
Â  Â  if(i < shots - 1) await new Promise(r=>setTimeout(r,360));
Â  }

Â  // stop camera and show white background (focus on result)
Â  stopCameraAndShowWhite();

Â  // compose preview (no shadow) and show modal
Â  preparePreviewAndFinal(capturedCanvases);

Â  modalOverlay.style.display = 'flex';
}

/* stop camera */
function stopCameraAndShowWhite(){
Â  try{
Â  Â  const stream = video.srcObject;
Â  Â  if(stream && stream.getTracks) stream.getTracks().forEach(t=>t.stop());
Â  }catch(e){}
Â  document.getElementById('cameraWrap').style.background = '#ffffff'; // Sesuai permintaan (putih)
Â  video.style.display = 'none';
}

/* restart camera */
async function restartCamera(){
Â  try{
Â  Â  video.style.display = 'block';
Â  Â  document.getElementById('cameraWrap').style.background = 'var(--bg)'; // Kembalikan ke bg awal
Â  Â  const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user', width:{ideal:1920}, height:{ideal:1080} }, audio:false });
Â  Â  video.srcObject = stream;
Â  }catch(err){
Â  Â  console.warn('restart camera failed', err);
Â  }
}

/* build preview (no shadow) and set up final canvases */
function preparePreviewAndFinal(captured){
Â  // clear UI areas
Â  stripPhoto.innerHTML = '';
Â  finalPreviewWrap.innerHTML = '';
Â  // itemList.innerHTML = ''; // <-- Dihapus
Â  uploadedUrlEl.textContent = 'Not uploaded';
Â  lastDitherDataUrl = null;
Â  lastUploadUrl = null;
Â  lastNoShadowCanvas = null;

Â  // populate stripPhoto images (4:3 crops) for visual reference
Â  const modalWidth = Math.min(640, Math.max(360, Math.floor(window.innerWidth * 0.6)));
Â  const displayW = Math.min(520, modalWidth - 40);
  
Â  /* FIX: only show thumbnails (stripPhoto) when there are 2 or 3 photos. */
Â  if (captured.length > 1) {
Â  Â  captured.forEach(c => {
Â  Â  Â  const cropped = cropCenterTo4x3(c, displayW);
Â  Â  Â  applyFintage(cropped);
Â  Â  Â  const img = document.createElement('img');
Â  Â  Â  img.src = cropped.toDataURL('image/jpeg',0.94);
Â  Â  Â  img.style.marginBottom = STRIP_GAP + 'px';
Â  Â  Â  stripPhoto.appendChild(img);
Â  Â  });
Â  } else {
Â  Â  stripPhoto.innerHTML = '';
Â  }

Â  // receipt metadata
Â  const txId = 'VZ-' + Date.now().toString(36).toUpperCase().slice(-8);
Â  const dateStr = new Date().toLocaleString('en-GB', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });

  /* --- PERBAIKAN 1.6: Blok kode "lines" yang mengisi itemList dihapus --- */

Â  // compose no-shadow final canvas (1080x1920) - used for preview (rendered as image) and for print dithering
Â  const noShadow = composeFinalNoShadow(captured, txId, dateStr);
Â  lastNoShadowCanvas = noShadow;

Â  // create preview image (no shadow)
Â  try{
Â  Â  const dataUrl = noShadow.toDataURL('image/jpeg',0.92);
Â  Â  const img = document.createElement('img');
Â  Â  img.src = dataUrl;
Â  Â  img.className = 'finalPreviewImg';
Â  Â  // ensure single preview element only
Â  Â  finalPreviewWrap.innerHTML = '';
Â  Â  finalPreviewWrap.appendChild(img);
Â  }catch(e){
Â  Â  console.warn('preview image creation failed', e);
Â  }

Â  // prepare dither (for print) from noShadow canvas
Â  lastDitherDataUrl = floydDither(noShadow, PRINT_W);
}

/* ================== Upload & QR popup ================== */

/* upload final with shadow (build an upload canvas which includes shadow) */
async function uploadFinalWithShadowAndShowQr(){
Â  if(!lastNoShadowCanvas) { alert('Nothing to upload.'); return; }
Â  if(lastUploadUrl){ // Jika sudah di-upload, jangan upload lagi
    showQrPopup(lastUploadUrl);
    return;
  }
  
  uploadBtn.disabled = true; uploadBtn.textContent = 'Uploading...';
Â  try{
Â  Â  // build upload canvas with shadow baked-in
Â  Â  const shadowCanvas = composeUploadWithShadow(lastNoShadowCanvas);
Â  Â  // upload this shadow canvas to Cloudinary
Â  Â  const url = await uploadCanvasToCloudinary(shadowCanvas);
Â  Â  lastUploadUrl = url;
Â  Â  uploadedUrlEl.textContent = 'Uploaded: ' + url.slice(0, 40) + '...';
Â  Â  // show QR popup (with URL)
Â  Â  showQrPopup(url);
Â  Â  uploadBtn.textContent = 'Uploaded';
Â  }catch(err){
Â  Â  alert('Upload failed: ' + (err.message || err));
Â  Â  uploadBtn.textContent = 'â˜ï¸ Upload';
Â  } finally {
Â  Â  uploadBtn.disabled = false; // Selalu enable lagi tombolnya
Â  }
}

/* POST canvas to Cloudinary (returns secure_url) */
async function uploadCanvasToCloudinary(canvas){
Â  const dataUrl = canvas.toDataURL('image/jpeg',0.92);
Â  const blob = await (await fetch(dataUrl)).blob();
Â  const form = new FormData(); form.append('file', blob); form.append('upload_preset', UPLOAD_PRESET);
Â  const resp = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: form });
Â  if(!resp.ok){
Â  Â  const txt = await resp.text().catch(()=>null);
Â  Â  throw new Error('Upload failed: ' + (txt || resp.status));
Â  }
Â  const json = await resp.json();
Â  if(!json.secure_url) throw new Error('No secure_url returned');
Â  return json.secure_url;
}

/* show QR popup */
function showQrPopup(url){
Â  qrcodeHost.innerHTML = '';
  /* --- PERBAIKAN 4.3 & 4.4: Ukuran QR diperbesar, Error Correction diubah --- */
Â  new QRCode(qrcodeHost, { text: url, width: 250, height: 250, correctLevel: QRCode.CorrectLevel.M });
Â  barcodeUrlText.textContent = url;
Â  barcodePopup.style.display = 'flex';
Â  barcodePopup.onclick = (e)=>{ if(e.target === barcodePopup) barcodePopup.style.display = 'none'; };
}

/* ================== Events ================== */
startBtn.addEventListener('click', ()=>{ runSession(); });

retakeBtn.addEventListener('click', async ()=>{
Â  // close modal and restart
Â  modalOverlay.style.display = 'none';
Â  capturedCanvases = []; lastUploadUrl = null; lastNoShadowCanvas = null; lastDitherDataUrl = null;
Â  uploadedUrlEl.textContent = 'Not uploaded';
  uploadBtn.textContent = 'â˜ï¸ Upload'; // Reset tombol upload
Â  
Â  await restartCamera(); // Panggil restartCamera (sudah termasuk show video & set bg)
Â  
  startCard.style.display = 'block';
Â  startCard.style.transition = 'none'; // Matikan transisi agar langsung muncul
Â  await new Promise(r=>setTimeout(r,10)); // delay singkat
Â  startCard.style.opacity = '1';
Â  startCard.style.transform = 'translateY(0)';
});

printBtn.addEventListener('click', ()=>{
Â  // print uses the no-shadow canvas dithered version (thermal)
Â  if(window.AndroidPrinter && lastDitherDataUrl){
Â  Â  try{ window.AndroidPrinter.printImage(lastDitherDataUrl); }catch(e){ alert('Failed to call AndroidPrinter: ' + e.message); }
IÂ  } else {
Â  Â  if(lastDitherDataUrl){
Â  Â  Â  const w = window.open(); w.document.body.style.margin = '0';
Â  Â  Â  const img = w.document.createElement('img'); img.src = lastDitherDataUrl; img.style.width='100%';
Â  Â  Â  w.document.body.appendChild(img);
Â  Â  } else alert('No printable image ready.');
Â  }
});

uploadBtn.addEventListener('click', async ()=>{
Â  await uploadFinalWithShadowAndShowQr();
});

barcodeClose.addEventListener('click', ()=>{ barcodePopup.style.display = 'none'; });

/* space to start */
window.addEventListener('keydown',(e)=>{ 
  if(e.code==='Space' && !startBtn.disabled && startCard.style.opacity === '1'){ 
    e.preventDefault(); 
    startBtn.click(); 
  } 
});

/* cleanup camera tracks */
window.addEventListener('beforeunload', ()=>{ const s = video.srcObject; if(s && s.getTracks) s.getTracks().forEach(t=>t.stop()); });

</script>
</body>
</html>
